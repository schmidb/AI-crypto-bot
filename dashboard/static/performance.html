<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance - AI Crypto Trading Bot</title>
    <!-- Bootstrap 5 CSS with Bootswatch Yeti Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/yeti/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Shared Header CSS -->
    <link rel="stylesheet" href="shared-header.css">
    <style>
        /* Custom styles to enhance Yeti theme */
        :root {
            --yeti-primary: #008cba;
            --yeti-secondary: #6c757d;
            --yeti-success: #28a745;
            --yeti-danger: #dc3545;
            --yeti-warning: #ffc107;
            --yeti-info: #17a2b8;
            --yeti-light: #f8f9fa;
            --yeti-dark: #343a40;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Open Sans', sans-serif;
        }

        .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .card-header {
            background-color: var(--yeti-primary);
            color: white;
            font-weight: 600;
            border-bottom: none;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--yeti-primary) !important;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-online { background-color: var(--yeti-success); }
        .status-offline { background-color: var(--yeti-danger); }

        .metric-small {
            text-align: center;
            padding: 0.75rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            border: 2px solid #e9ecef;
            margin: 0.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .metric-small .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            color: #212529;
        }
        
        .metric-small .metric-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .portfolio-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--yeti-success);
        }

        .balance-status {
            background-color: var(--yeti-light);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--yeti-warning);
        }

        .balance-item {
            text-align: center;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .balance-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--yeti-primary);
        }

        .balance-label {
            font-size: 0.9em;
            color: var(--yeti-secondary);
            margin-top: 5px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.4;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .help-icon {
            font-size: 0.8rem;
            opacity: 0.7;
            cursor: help;
            margin-left: 5px;
        }

        .help-icon-css {
            font-size: 0.7rem;
            opacity: 0.7;
            cursor: help;
        }

        .example {
            margin-top: 8px;
            padding: 6px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 4px;
            font-style: italic;
            font-size: 0.8rem;
        }

        .tooltiptext h6 {
            color: #fff;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .tooltiptext ul {
            margin: 8px 0;
            padding-left: 16px;
        }

        .tooltiptext li {
            margin-bottom: 4px;
        }

        .page-title {
            color: var(--yeti-primary);
            font-weight: 700;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid var(--yeti-primary);
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Shared Header -->
    <div id="shared-header"></div>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="page-title">
                    <i class="fas fa-chart-line me-3"></i>
                    Trading Performance Analytics
                </h1>
            </div>
        </div>

        <!-- Live Performance Overview -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h5 class="card-title">
                            Total Return
                            <i class="fas fa-question-circle ms-1" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               data-bs-html="true"
                               title="<strong>Total Portfolio Return:</strong><br/>
                                      • Overall performance since bot started<br/>
                                      • Initial investment: €333.81<br/>
                                      • Includes all realized + unrealized gains<br/>
                                      • Based on current market prices<br/>
                                      <em>This is your complete trading performance</em>"
                               style="font-size: 0.8rem; opacity: 0.8; cursor: help;">
                            </i>
                        </h5>
                        <h3 id="total-return">+0.00%</h3>
                        <small id="total-return-usd">€0.00</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-calendar-day fa-2x mb-2"></i>
                        <h5 class="card-title">
                            Today's P&L
                            <i class="fas fa-question-circle ms-1" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               data-bs-html="true"
                               title="<strong>Today's Performance Details:</strong><br/>
                                      • Portfolio change since midnight<br/>
                                      • Includes realized + unrealized gains<br/>
                                      • Based on current market prices<br/>
                                      • Updates every 60 seconds<br/>
                                      <em>Note: Calculated from portfolio value changes</em>"
                               style="font-size: 0.8rem; opacity: 0.8; cursor: help;">
                            </i>
                        </h5>
                        <h3 id="daily-pnl">+€0.00</h3>
                        <small id="daily-pnl-percent">+0.00%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-percentage fa-2x mb-2"></i>
                        <h5 class="card-title">
                            Win Rate
                            <i class="fas fa-question-circle ms-1" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               data-bs-html="true"
                               title="<strong>AI Decision Success Rate:</strong><br/>
                                      • Based on trade confidence levels<br/>
                                      • Trades with 70%+ confidence = 'Win'<br/>
                                      • Only counts actual buy/sell trades<br/>
                                      • Hold decisions are excluded<br/>
                                      <em>Higher confidence typically means better outcomes</em>"
                               style="font-size: 0.8rem; opacity: 0.8; cursor: help;">
                            </i>
                        </h5>
                        <h3 id="win-rate">0%</h3>
                        <small id="win-loss-ratio">0/0 trades</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-balance-scale fa-2x mb-2"></i>
                        <h5 class="card-title">
                            Portfolio Value
                            <span class="tooltip">
                                <i class="fas fa-question-circle help-icon"></i>
                                <span class="tooltiptext">
                                    <h6>Total Portfolio Value</h6>
                                    Shows the current total EUR value of all your cryptocurrency holdings and cash.
                                    <div class="example">
                                        Includes: BTC + ETH + SOL + EUR cash balance
                                    </div>
                                </span>
                            </span>
                        </h5>
                        <h3 id="current-portfolio-value">€0.00</h3>
                        <small id="portfolio-change">vs initial</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trade Performance -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-history me-2"></i>Recent Trade Performance
                            <i class="fas fa-question-circle ms-1" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               data-bs-html="true"
                               title="<strong>Recent Trade Details:</strong><br/>
                                      • <strong>Confidence:</strong> AI's confidence in the decision (0-100%)<br/>
                                      • <strong>Amount:</strong> EUR value traded (or 'Hold' if no trade)<br/>
                                      • <strong>Status:</strong> Executed = trade completed, Hold = no action taken<br/>
                                      <em>Note: P&L tracking requires time to assess trade outcomes</em>"
                               style="font-size: 0.8rem; opacity: 0.8; cursor: help;">
                            </i>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Action</th>
                                        <th>Confidence</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-trades-performance">
                                    <!-- Recent trades with P&L will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Active Strategy Status</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span>Confidence Threshold:</span>
                                    <strong>60%</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span>
                                        Market Risk Level
                                        <span class="help-icon-css" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           data-bs-html="true"
                                           title="<strong>Market Risk Assessment</strong><br/>
                                                  This measures market volatility and uncertainty, not bot confidence.<br/>
                                                  <br/>
                                                  • Affects position sizing:<br/>
                                                  &nbsp;&nbsp;HIGH = 50% position size<br/>
                                                  &nbsp;&nbsp;MEDIUM = 75% position size<br/>
                                                  &nbsp;&nbsp;LOW = 100% position size<br/>
                                                  <br/>
                                                  <em>Based on volatility, indicator conflicts, and price movements</em>"
                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                        </span>
                                    </span>
                                    <strong id="current-risk-level">High</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span>MACD Weight:</span>
                                    <strong>40%</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span>RSI Weight:</span>
                                    <strong>30%</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span>BB Weight:</span>
                                    <strong>30%</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span>Alignment Bonus:</span>
                                    <strong>+10%</strong>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row g-2">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span>Last Rebalancing:</span>
                                    <strong id="last-rebalance">Never</strong>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span>Next Decision:</span>
                                    <strong id="next-decision-time">--:--</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Asset Allocation vs Target -->
        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-pie-chart me-2"></i>Current vs Target Allocation
                            <span class="tooltip">
                                <i class="fas fa-question-circle help-icon"></i>
                                <span class="tooltiptext">
                                    <h6>Portfolio Allocation Analysis</h6>
                                    Compares your current asset distribution with the optimal target allocation.
                                    <ul>
                                        <li><strong>Current %:</strong> Your actual asset percentages right now</li>
                                        <li><strong>Target %:</strong> Optimal allocation for the enhanced trading strategy</li>
                                        <li><strong>Color Coding:</strong> Green = on target, Yellow/Red = needs rebalancing</li>
                                        <li><strong>Threshold:</strong> Rebalancing triggers when deviation exceeds 5%</li>
                                    </ul>
                                    <div class="example">Target: 26.7% each for BTC/ETH/SOL, 20% EUR for trading liquidity.</div>
                                </span>
                            </span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3" id="btc-allocation">
                                <div class="text-center">
                                    <h6>BTC</h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="btc-progress">
                                            <span id="btc-percent">0%</span>
                                        </div>
                                    </div>
                                    <small class="text-muted">Target: <span id="btc-target">26.7%</span></small>
                                </div>
                            </div>
                            <div class="col-md-3" id="eth-allocation">
                                <div class="text-center">
                                    <h6>ETH</h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="eth-progress">
                                            <span id="eth-percent">0%</span>
                                        </div>
                                    </div>
                                    <small class="text-muted">Target: <span id="eth-target">26.7%</span></small>
                                </div>
                            </div>
                            <div class="col-md-3" id="sol-allocation">
                                <div class="text-center">
                                    <h6>SOL</h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="sol-progress">
                                            <span id="sol-percent">0%</span>
                                        </div>
                                    </div>
                                    <small class="text-muted">Target: <span id="sol-target">26.7%</span></small>
                                </div>
                            </div>
                            <div class="col-md-3" id="usd-allocation">
                                <div class="text-center">
                                    <h6>EUR</h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%" id="usd-progress">
                                            <span id="usd-percent">0%</span>
                                        </div>
                                    </div>
                                    <small class="text-muted">Target: <span id="usd-target">20.0%</span></small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="alert alert-info" id="rebalance-alert" style="display: none;">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="rebalance-message">Portfolio allocation is within target ranges.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="row g-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-area me-2"></i>Portfolio Value Over Time</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="performance-chart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for performance charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Shared Header JS -->
    <script src="shared-header.js"></script>
    <script>
        // Load shared header and initialize
        async function loadSharedHeader() {
            try {
                const response = await fetch('shared-header.html');
                if (!response.ok) throw new Error('Failed to load header');
                const html = await response.text();
                document.getElementById('shared-header').innerHTML = html;
                
                // Initialize header functionality
                initializeHeader('performance');
            } catch (error) {
                console.error('Error loading header:', error);
                // Fallback: show a basic header
                document.getElementById('shared-header').innerHTML = `
                    <nav class="navbar navbar-expand-lg">
                        <div class="container-fluid">
                            <a class="navbar-brand" href="https://github.com/schmidb/AI-crypto-bot" target="_blank">
                                <i class="fas fa-robot me-2"></i>
                                AI Crypto Bot - Performance
                            </a>
                        </div>
                    </nav>
                `;
            }
        }

        // Performance page specific JavaScript
        let performanceChart = null;

        // Function to load data
        async function loadData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                
                // Handle text files (like last_updated.txt)
                if (url.endsWith('.txt')) {
                    return await response.text();
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error loading data from', url, ':', error);
                return null;
            }
        }

        // Function to update performance metrics
        async function updatePerformanceMetrics() {
            const portfolio = await loadData('/crypto-bot/data/portfolio/portfolio.json');
            const trades = await loadData('/crypto-bot/data/trades/trade_history.json');
            
            if (portfolio) {
                // Calculate total return
                const initialValue = portfolio.initial_value_eur || 0;
                const currentValue = portfolio.portfolio_value_eur || 0;
                const totalReturn = initialValue > 0 ? ((currentValue - initialValue) / initialValue * 100) : 0;
                const totalReturnUsd = currentValue - initialValue;
                
                // Update total return
                document.getElementById('total-return').textContent = 
                    (totalReturn >= 0 ? '+' : '') + totalReturn.toFixed(2) + '%';
                document.getElementById('total-return-usd').textContent = 
                    (totalReturnUsd >= 0 ? '+€' : '€') + totalReturnUsd.toFixed(2);
                
                // Calculate daily P&L (simplified - would need historical data for accuracy)
                const dailyPnl = 0; // Placeholder
                const dailyPnlPercent = 0; // Placeholder
                
                document.getElementById('daily-pnl').textContent = 
                    (dailyPnl >= 0 ? '+€' : '€') + dailyPnl.toFixed(2);
                document.getElementById('daily-pnl-percent').textContent = 
                    (dailyPnlPercent >= 0 ? '+' : '') + dailyPnlPercent.toFixed(2) + '%';
                
                // Update current portfolio value
                document.getElementById('current-portfolio-value').textContent = 
                    '€' + currentValue.toFixed(2);
                document.getElementById('portfolio-change').textContent = 
                    'vs initial €' + initialValue.toFixed(2);
            }
            
            if (trades && trades.length > 0) {
                // Calculate win rate based on confidence levels
                const actualTrades = trades.filter(trade => 
                    trade.action && trade.action.toLowerCase() !== 'hold'
                );
                
                // For now, we'll use confidence as a proxy for success
                // In a real implementation, you'd track actual P&L per trade
                const highConfidenceTrades = actualTrades.filter(trade => trade.confidence >= 70);
                const winRate = actualTrades.length > 0 ? 
                    (highConfidenceTrades.length / actualTrades.length * 100) : 0;
                
                document.getElementById('win-rate').textContent = winRate.toFixed(0) + '%';
                document.getElementById('win-loss-ratio').textContent = 
                    `${highConfidenceTrades.length}/${actualTrades.length} trades`;
                
                // Update recent trades performance
                updateRecentTradesPerformance(actualTrades.slice(-5));
            }
            
            // Update allocation progress bars
            updateAllocationBars(portfolio);
        }

        // Function to update recent trades performance
        function updateRecentTradesPerformance(recentTrades) {
            const tbody = document.getElementById('recent-trades-performance');
            if (!recentTrades || recentTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No recent trades</td></tr>';
                return;
            }
            
            const html = recentTrades.map(trade => {
                const asset = trade.product_id ? trade.product_id.split('-')[0] : 'Unknown';
                const action = trade.action ? trade.action.toUpperCase() : 'UNKNOWN';
                const confidence = trade.confidence || 0;
                const tradeAmount = trade.trade_amount_usd || 0;
                const status = trade.status || 'Unknown';
                
                const confidenceClass = confidence >= 70 ? 'text-success' : 
                                      confidence >= 50 ? 'text-warning' : 'text-danger';
                const statusClass = status === 'executed' ? 'text-success' : 'text-muted';
                
                return `
                    <tr>
                        <td><strong>${asset}</strong></td>
                        <td><span class="badge bg-${action === 'BUY' ? 'success' : action === 'SELL' ? 'danger' : 'secondary'}">${action}</span></td>
                        <td><span class="${confidenceClass}">${confidence}%</span></td>
                        <td>${tradeAmount > 0 ? '€' + tradeAmount.toFixed(2) : 'Hold'}</td>
                        <td><span class="${statusClass}">${status}</span></td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }

        // Function to update allocation progress bars
        function updateAllocationBars(portfolio) {
            if (!portfolio || !portfolio.balances) return;
            
            const totalValue = portfolio.portfolio_value_eur || 0;
            if (totalValue === 0) return;
            
            // Calculate current allocations
            const btcValue = (portfolio.balances.BTC || 0) * (portfolio.prices?.['BTC-EUR'] || 0);
            const ethValue = (portfolio.balances.ETH || 0) * (portfolio.prices?.['ETH-EUR'] || 0);
            const solValue = (portfolio.balances.SOL || 0) * (portfolio.prices?.['SOL-EUR'] || 0);
            const eurValue = portfolio.balances.EUR || 0;
            
            const btcPercent = (btcValue / totalValue * 100);
            const ethPercent = (ethValue / totalValue * 100);
            const solPercent = (solValue / totalValue * 100);
            const eurPercent = (eurValue / totalValue * 100);
            
            // Update progress bars
            updateProgressBar('btc', btcPercent, 30);
            updateProgressBar('eth', ethPercent, 30);
            updateProgressBar('sol', solPercent, 30);
            updateProgressBar('usd', eurPercent, 10);
            
            // Check if rebalancing is needed
            const needsRebalancing = 
                Math.abs(btcPercent - 30) > 5 ||
                Math.abs(ethPercent - 30) > 5 ||
                Math.abs(solPercent - 30) > 5 ||
                Math.abs(eurPercent - 10) > 5;
            
            const alert = document.getElementById('rebalance-alert');
            if (needsRebalancing) {
                alert.style.display = 'block';
                alert.className = 'alert alert-warning';
                document.getElementById('rebalance-message').textContent = 
                    'Portfolio allocation deviates from targets. Consider rebalancing.';
            } else {
                alert.style.display = 'block';
                alert.className = 'alert alert-success';
                alert.style.color = '#000';
                alert.style.backgroundColor = '#d1edff';
                alert.style.borderColor = '#bee5eb';
                document.getElementById('rebalance-message').textContent = 
                    'Portfolio allocation is within target ranges.';
            }
        }

        // Helper function to update individual progress bars
        function updateProgressBar(asset, currentPercent, targetPercent) {
            const progressBar = document.getElementById(`${asset}-progress`);
            const percentSpan = document.getElementById(`${asset}-percent`);
            const targetSpan = document.getElementById(`${asset}-target`);
            
            if (progressBar && percentSpan) {
                progressBar.style.width = Math.min(currentPercent, 100) + '%';
                percentSpan.textContent = currentPercent.toFixed(1) + '%';
                
                // Color coding based on deviation from target
                const deviation = Math.abs(currentPercent - targetPercent);
                if (deviation <= 2) {
                    progressBar.className = progressBar.className.replace(/bg-\w+/, 'bg-success');
                } else if (deviation <= 5) {
                    progressBar.className = progressBar.className.replace(/bg-\w+/, 'bg-warning');
                } else {
                    progressBar.className = progressBar.className.replace(/bg-\w+/, 'bg-danger');
                }
            }
            
            if (targetSpan) {
                targetSpan.textContent = targetPercent.toFixed(1) + '%';
            }
        }

        // Function to create performance chart
        async function updatePerformanceChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            // For now, create a simple chart with sample data
            // In a real implementation, you'd load historical portfolio values
            const sampleData = {
                labels: ['7 days ago', '6 days ago', '5 days ago', '4 days ago', '3 days ago', '2 days ago', '1 day ago', 'Today'],
                values: [333.81, 335.20, 332.15, 338.90, 341.25, 339.80, 342.10, 338.90] // Sample portfolio values
            };
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampleData.labels,
                    datasets: [{
                        label: 'Portfolio Value (€)',
                        data: sampleData.values,
                        borderColor: '#008cba',
                        backgroundColor: 'rgba(0, 140, 186, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toFixed(0);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Portfolio Value: €' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize tooltips
        function initializeTooltips() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Update all performance data
        function updateAllPerformanceData() {
            updatePerformanceMetrics();
            updatePerformanceChart();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Load shared header first
            await loadSharedHeader();
            
            // Initialize tooltips
            initializeTooltips();
            
            // Load initial data
            updateAllPerformanceData();
            
            // Update every 60 seconds
            setInterval(updateAllPerformanceData, 60000);
        });
    </script>
</body>
</html>
