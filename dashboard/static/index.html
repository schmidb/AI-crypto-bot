<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crypto Trading Bot Dashboard</title>
    <!-- Bootstrap 5 CSS with Bootswatch Yeti Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/yeti/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Multi-Strategy Styles -->
    <link href="multi-strategy.css" rel="stylesheet">
    <style>
        /* Custom styles to enhance Yeti theme */
        :root {
            --yeti-primary: #008cba;
            --yeti-secondary: #6c757d;
            --yeti-success: #28a745;
            --yeti-danger: #dc3545;
            --yeti-warning: #ffc107;
            --yeti-info: #17a2b8;
            --yeti-light: #f8f9fa;
            --yeti-dark: #343a40;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Open Sans', sans-serif;
        }

        .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .card-header {
            background-color: var(--yeti-primary);
            color: white;
            font-weight: 600;
            border-bottom: none;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--yeti-primary) !important;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-online { background-color: var(--yeti-success); }
        .status-offline { background-color: var(--yeti-danger); }
        .metric-small {
            text-align: center;
            padding: 0.75rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            border: 2px solid #e9ecef;
            margin: 0.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .metric-small .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            color: #212529;
        }
        
        .metric-small .metric-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .portfolio-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--yeti-success);
        }

        .balance-status {
            background-color: var(--yeti-light);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--yeti-warning);
        }

        .balance-item {
            text-align: center;
        }

        .balance-value {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .balance-value .amount {
            color: var(--text-primary);
        }

        .balance-value .status-icon {
            font-size: 0.9em;
        }

        .trading-status .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .balance-explanation {
            text-align: center;
            padding: 8px;
            background-color: rgba(255, 193, 7, 0.1);
            border-radius: 4px;
        }

        .balance-explanation .fas {
            margin-right: 4px;
        }

        .rebalancing-section {
            background-color: var(--yeti-light);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--yeti-info);
        }

        .rebalancing-section h6 {
            color: var(--text-primary);
            font-weight: 600;
        }

        .rebalance-status {
            padding: 8px;
            background-color: rgba(13, 202, 240, 0.1);
            border-radius: 4px;
        }

        #rebalance-mode-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .rebalance-details {
            padding: 8px;
            background-color: rgba(108, 117, 125, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--yeti-secondary);
        }

        .rebalance-details div {
            margin-bottom: 4px;
        }

        .trade-details-row {
            background-color: rgba(13, 202, 240, 0.05);
            border-left: 4px solid var(--yeti-info);
        }

        .trade-details-content {
            padding: 20px;
            background-color: var(--yeti-light);
            border-radius: 8px;
            margin: 10px;
        }

        .detail-section {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .detail-title {
            color: var(--yeti-info);
            font-weight: 600;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(13, 202, 240, 0.2);
            padding-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 120px;
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 400;
            text-align: right;
        }

        .reasoning-detailed {
            background-color: rgba(108, 117, 125, 0.1);
            border-radius: 4px;
            padding: 12px;
            font-style: italic;
            color: var(--text-primary);
            line-height: 1.4;
        }
        
        .ai-analysis-comprehensive {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .analysis-header h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
        }
        
        .analysis-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            padding: 1rem;
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }
        
        .analysis-title {
            color: #343a40;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .reasoning-point {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: rgba(0, 123, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid #007bff;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .indicator-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .decision-item {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: rgba(108, 117, 125, 0.1);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .context-item {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: rgba(23, 162, 184, 0.1);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .execution-message {
            background-color: rgba(25, 135, 84, 0.1);
            border-left: 3px solid var(--yeti-success);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .expand-button {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .expand-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .reasoning-container {
            max-width: 300px;
        }

        /* Educational Tooltips Styling */
        .help-icon {
            color: #ff6600;
            cursor: help;
            margin-left: 8px;
            font-size: 1rem;
            opacity: 1;
            transition: all 0.2s ease;
            background-color: rgba(23, 162, 184, 0.1);
            border-radius: 50%;
            padding: 2px;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(23, 162, 184, 0.3);
        }

        .help-icon:hover {
            opacity: 1;
            color: #ff4400;
            background-color: rgba(0, 140, 186, 0.15);
            border-color: var(--yeti-primary);
            transform: scale(1.1);
        }

        /* Plain CSS Question Mark Icon */
        .help-icon-css {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #17a2b8;
            color: white;
            font-size: 12px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            cursor: help;
            margin-left: 8px;
            transition: all 0.2s ease;
            border: 2px solid #17a2b8;
        }

        .help-icon-css:hover {
            background-color: #138496;
            border-color: #138496;
            transform: scale(1.1);
        }

        .help-icon-css::before {
            content: "?";
            line-height: 1;
        }

        /* Orange variant for blue backgrounds */
        .help-icon-css-orange {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #ff6600;
            color: white;
            font-size: 12px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            cursor: help;
            margin-left: 8px;
            transition: all 0.2s ease;
            border: 2px solid #ff6600;
            position: relative;
            z-index: 1;
        }

        .help-icon-css-orange:hover {
            background-color: #ff4400;
            border-color: #ff4400;
            transform: scale(1.1);
        }

        .help-icon-css-orange::before {
            content: "?";
            line-height: 1;
        }

        /* Ensure tooltip works with orange icon */
        .tooltip .help-icon-css-orange:hover + .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(-5px);
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 320px;
            background-color: #2c3e50;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 15px;
            position: absolute;
            z-index: 9999;
            bottom: 130%;
            left: 50%;
            margin-left: -160px;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            line-height: 1.5;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border: 2px solid var(--yeti-info);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(-5px);
        }

        /* Ensure tooltip works when hovering over any child element */
        .tooltip:hover .tooltiptext,
        .tooltip .help-icon-css:hover + .tooltiptext,
        .tooltip .help-icon-css-orange:hover + .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(-5px);
        }

        .tooltip .tooltiptext h6 {
            color: var(--yeti-info);
            margin: 0 0 10px 0;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(23, 162, 184, 0.3);
            padding-bottom: 5px;
        }

        .tooltip .tooltiptext ul {
            margin: 10px 0;
            padding-left: 18px;
        }

        .tooltip .tooltiptext li {
            margin-bottom: 6px;
        }

        .tooltip .tooltiptext .example {
            background-color: rgba(13, 202, 240, 0.15);
            padding: 8px 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-style: italic;
            border-left: 3px solid var(--yeti-info);
        }

        /* Responsive tooltip positioning */
        @media (max-width: 768px) {
            .tooltip .tooltiptext {
                width: 280px;
                margin-left: -140px;
                font-size: 0.8rem;
            }
        }

        /* Bootstrap tooltip override for better visibility */
        .tooltip-inner {
            background-color: #2c3e50 !important;
            color: #fff !important;
            border: 2px solid var(--yeti-info) !important;
            font-size: 0.85rem !important;
            max-width: 300px !important;
            text-align: left !important;
            padding: 10px 12px !important;
        }

        .bs-tooltip-top .tooltip-arrow::before {
            border-top-color: #2c3e50 !important;
        }

        .bs-tooltip-bottom .tooltip-arrow::before {
            border-bottom-color: #2c3e50 !important;
        }

        .nav-link {
            color: var(--yeti-dark) !important;
            font-weight: 500;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--yeti-primary) !important;
            background-color: rgba(0, 140, 186, 0.1);
            border-radius: 8px;
        }

        .navbar-brand {
            color: var(--accent-gold) !important;
            font-weight: 700;
        }

        .table {
            color: var(--text-secondary);
        }

        .table th {
            color: var(--text-primary);
            font-weight: 600;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .table td {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .form-select {
            background-color: white !important;
            border: 1px solid #ced4da !important;
            color: var(--yeti-dark) !important;
        }

        .form-select:focus {
            background-color: white !important;
            border-color: var(--yeti-primary) !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 140, 186, 0.25) !important;
        }

        .form-label {
            color: var(--yeti-dark);
            font-weight: 500;
        }

        .btn-primary {
            background-color: var(--yeti-primary);
            border-color: var(--yeti-primary);
        }

        .btn-link {
            color: var(--yeti-primary) !important;
        }

        .btn-link:hover {
            color: #006a8a !important;
        }

        .nav-link:hover {
            color: #fff;
        }

        .nav-link.active {
            color: #ffd700 !important;
            border-color: #ffd700 !important;
        }

        .table {
            color: #fff;
        }

        .table td, .table th {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .progress {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #live-clock {
            color: #a0c4ff;
        }

        .coinbase-link {
            color: #fff;
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background: rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s;
        }

        .coinbase-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .countdown-timer {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        .filter-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .decision-reason {
            max-height: 3.6em;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            color: var(--yeti-dark);
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.9rem;
            line-height: 1.4;
            border: 1px solid #e9ecef;
        }

        .decision-reason.expanded {
            max-height: none;
        }

        .expand-button {
            cursor: pointer;
            color: var(--accent-gold) !important;
            font-size: 0.85rem;
            font-weight: 500;
            text-decoration: none !important;
            transition: color 0.2s ease;
        }

        .badge {
            font-weight: 500;
            font-size: 0.8rem;
        }

        .badge.bg-success {
            background-color: #28a745 !important;
            color: #ffffff !important;
        }

        .badge.bg-danger {
            background-color: #dc3545 !important;
            color: #ffffff !important;
        }

        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #000000 !important;
        }

        .text-success {
            color: #4caf50 !important;
        }

        .text-danger {
            color: #f44336 !important;
        }

        .text-warning {
            color: #ff9800 !important;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--text-primary);
            font-weight: 600;
        }

        .lead {
            color: var(--text-secondary);
        }

        .small, small {
            color: var(--text-muted);
        }

        .allocation-comparison {
            height: 200px;
        }

        .market-asset-card {
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            height: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .market-asset-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .market-asset-card .current-price {
            font-size: 1.75rem;
            font-weight: bold;
            color: #ffd700;
        }

        .changes-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            padding: 0.75rem;
            border-radius: 0.375rem;
        }

        .change-item {
            text-align: center;
        }

        .change-label {
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 0.25rem;
        }

        .change-value {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .decision-badge .badge {
            font-size: 0.8rem;
            padding: 0.35rem 0.65rem;
        }

        .confidence-value {
            font-weight: 600;
            color: #ffd700;
        }

        .time-value {
            font-size: 0.85rem;
        }

        .coinbase-link {
            color: #17a2b8;
            opacity: 0.8;
            transition: all 0.2s;
            text-decoration: none;
        }

        .coinbase-link:hover {
            opacity: 1;
            color: #138496;
            transform: scale(1.1);
        }

        .reasoning-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reasoning-text {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--yeti-dark);
            max-height: 3.6em;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border-left: 3px solid var(--yeti-primary);
            border: 1px solid #e9ecef;
        }

        .reasoning-text.expanded {
            max-height: none;
        }

        /* Enhanced Decision Structure Styles */
        .enhanced-decision-section {
            border-top: 1px solid #e9ecef;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        .ai-summary {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border-left: 3px solid var(--yeti-primary);
        }

        .ai-recommendation {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .ai-rec-badge {
            font-size: 0.75rem;
            margin-left: 0.25rem;
        }

        .threshold-check i {
            font-size: 0.8rem;
        }

        .technical-indicators {
            background-color: #f1f3f4;
            padding: 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }

        .indicators-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .indicator-item {
            background-color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 0.2rem;
            border: 1px solid #dee2e6;
            font-size: 0.8rem;
        }

        .risk-management {
            background-color: #fff3cd;
            padding: 0.4rem;
            border-radius: 0.25rem;
            border-left: 3px solid #ffc107;
        }

        .risk-level-badge {
            font-size: 0.7rem;
        }

        .detailed-analysis {
            display: none;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }

        .detailed-analysis.expanded {
            display: block;
        }

        .analysis-section {
            margin-bottom: 0.75rem;
        }

        .analysis-section:last-child {
            margin-bottom: 0;
        }

        .analysis-section h6 {
            color: var(--yeti-primary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.25rem;
        }

        .analysis-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        .analysis-list li {
            padding: 0.25rem 0;
            font-size: 0.85rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .analysis-list li:last-child {
            border-bottom: none;
        }

        .analysis-list li:before {
            content: "▸";
            color: var(--yeti-primary);
            margin-right: 0.5rem;
        }

        .expand-button {
            color: var(--yeti-primary) !important;
            font-size: 0.8rem;
            text-decoration: none !important;
            margin-top: 0.25rem;
        }

        .expand-button:hover {
            color: #006a8a !important;
        }

        .expand-button:hover {
            color: #fff !important;
        }

        .simulation-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }

        .simulation-badge.simulation {
            background-color: #ffc107 !important;
            color: #000 !important;
        }

        .simulation-badge.live {
            background-color: #dc3545 !important;
            color: #fff !important;
        }

        #risk-level {
            font-weight: 600;
            text-transform: uppercase;
        }

        #market-volatility {
            font-weight: 600;
            text-transform: uppercase;
        }

        #trading-style {
            font-weight: 600;
            text-transform: uppercase;
        }

        #decision-frequency {
            font-weight: 600;
        }

        .risk-low { color: #28a745; }
        .risk-medium { color: #ffc107; }
        .risk-high { color: #dc3545; }
        
        .volatility-low { color: #28a745; }
        .volatility-medium { color: #ffc107; }
        .volatility-high { color: #dc3545; }
        .volatility-unknown { color: #6c757d; }
        
        /* Fix for table header text color - white text on white background issue */
        .table thead th {
            color: #212529 !important;  /* Dark gray, almost black */
            background-color: #f8f9fa !important;  /* Light gray background */
            font-weight: 600;  /* Make headers slightly bolder */
            border-bottom: 2px solid #dee2e6;  /* Add bottom border for definition */
        }
    </style>
    <!-- Shared Header CSS -->
    <link rel="stylesheet" href="shared-header.css">
</head>
<body>
    <!-- Load Shared Header -->
    <div id="shared-header"></div>

    <!-- Shared Header JavaScript -->
    <script src="shared-header.js"></script>
    <script>
        // Load shared header and initialize
        async function loadSharedHeader() {
            try {
                const response = await fetch('shared-header.html');
                if (!response.ok) throw new Error('Failed to load header');
                const html = await response.text();
                document.getElementById('shared-header').innerHTML = html;
                
                // Initialize header functionality
                initializeHeader('dashboard');
                
                // Header is now loaded and ready for updates
            } catch (error) {
                console.error('Error loading header:', error);
                // Fallback: show a basic header
                document.getElementById('shared-header').innerHTML = `
                    <nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
                        <div class="container-fluid">
                            <a class="navbar-brand" href="https://github.com/schmidb/AI-crypto-bot" target="_blank">
                                <i class="fas fa-robot me-2"></i>
                                AI Crypto Bot
                            </a>
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
                                    aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            <div class="collapse navbar-collapse" id="navbarContent">
                                <div class="navbar-nav me-auto">
                                    <a class="nav-link active" href="index.html">Dashboard</a>
                                    <a class="nav-link" href="analysis.html">Analysis</a>
                                    <a class="nav-link" href="config.html">Configuration</a>
                                </div>
                                <div class="navbar-nav ms-auto">
                                    <span class="navbar-text me-3" id="live-clock">
                                        <i class="far fa-clock me-1"></i>
                                        Loading...
                                    </span>
                                    <span class="navbar-text" id="bot-uptime">
                                        <i class="fas fa-history me-1"></i>
                                        Uptime: Loading...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </nav>
                `;
                // Initialize even with fallback
                initializeHeader('dashboard');
            }
        }
        
        // Load header when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadSharedHeader);
        } else {
            loadSharedHeader();
        }
    </script>

    <div class="container-fluid py-4">
        <!-- First Row - Bot Status and Portfolio Overview (Full Width) -->
        <div class="row g-4 mb-4">
            <!-- Bot Status Card -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            Bot Status
                            <span class="help-icon-css-orange"
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   title="<strong>AI Trading Bot Status</strong><br/>
                                          This section shows the current operational status of your AI-powered cryptocurrency trading bot.<br/>
                                          <br/>
                                          <strong>Status:</strong> Whether the bot is running, stopped, or has errors<br/>
                                          <strong>Uptime:</strong> How long the bot has been running continuously<br/>
                                          <strong>Next Decision:</strong> Countdown to the next AI trading analysis<br/>
                                          <strong>Last Update:</strong> When the bot last made a trading decision<br/>
                                          <br/>
                                          <em>The bot analyzes market conditions every 60 minutes and makes intelligent trading decisions.</em>">
                            </span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="status-indicator status-online me-2"></span>
                            <span id="bot-status">Online</span>
                            <span class="ms-2 badge simulation-badge">SIMULATION</span>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Next Decision:</small>
                            <div id="next-decision-timer" class="countdown-timer">Loading...</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Last Trade:</small>
                            <div id="last-update">Loading...</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                Prices Updated:
                                <span class="tooltip">
                                    <i class="fas fa-question-circle help-icon" style="font-size: 0.7rem;"></i>
                                    <span class="tooltiptext">
                                        <h6>Market Data Freshness</h6>
                                        Shows when the cryptocurrency prices were last updated from Coinbase.
                                        <ul>
                                            <li><strong>Real-time:</strong> Prices update every few minutes</li>
                                            <li><strong>Source:</strong> Live data from Coinbase Pro API</li>
                                            <li><strong>Accuracy:</strong> Reflects current market conditions</li>
                                        </ul>
                                        <div class="example">
                                            Fresh data ensures accurate trading decisions
                                        </div>
                                    </span>
                                </span>
                            </small>
                            <div id="market-data-update">Loading...</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                Bot Risk Management:
                                <span class="help-icon-css" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   title="<strong>Bot Risk Configuration:</strong><br/>
                                          Your bot's risk tolerance setting (static configuration).<br/>
                                          <br/>
                                          <strong>HIGH</strong>: Conservative (50% position sizes)<br/>
                                          <strong>MEDIUM</strong>: Balanced (75% position sizes)<br/>
                                          <strong>LOW</strong>: Aggressive (100% position sizes)<br/>
                                          <br/>
                                          This is different from current market volatility.<br/>
                                          <em>Set in .env file as RISK_LEVEL</em>"
                                   style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                </span>
                            </small>
                            <div id="risk-level">Loading...</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                Market Volatility:
                                <span class="help-icon-css" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   title="<strong>Current Market Volatility:</strong><br/>
                                          Real-time assessment of market conditions (dynamic analysis).<br/>
                                          <br/>
                                          <strong>HIGH</strong>: >5% price swings, high uncertainty<br/>
                                          <strong>MEDIUM</strong>: 2-5% price movements, moderate activity<br/>
                                          <strong>LOW</strong>: <2% price changes, stable conditions<br/>
                                          <br/>
                                          Based on recent price movements and technical indicators.<br/>
                                          <em>Updates with each market analysis</em>"
                                   style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                </span>
                            </small>
                            <div id="market-volatility">Loading...</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                Trading Style:
                                <span class="help-icon-css" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   title="<strong>Trading Strategy Configuration:</strong><br/>
                                          Your bot's trading approach and timeframe settings.<br/>
                                          <br/>
                                          <strong>DAY TRADING</strong>: Intraday positions (minutes to hours)<br/>
                                          <strong>SWING TRADING</strong>: Short-term positions (hours to days)<br/>
                                          <strong>LONG TERM</strong>: Position trading (days to weeks)<br/>
                                          <br/>
                                          This affects how the AI analyzes market data and makes decisions.<br/>
                                          <em>Set in .env file as TRADING_STYLE</em>"
                                   style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                </span>
                            </small>
                            <div id="trading-style">Loading...</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                Decision Frequency:
                                <span class="help-icon-css" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   title="<strong>AI Decision Frequency:</strong><br/>
                                          How often the AI analyzes market conditions and makes trading decisions.<br/>
                                          <br/>
                                          More frequent decisions enable faster response to market changes.<br/>
                                          <em>Set in .env file as DECISION_INTERVAL_MINUTES</em>"
                                   style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                </span>
                            </small>
                            <div id="decision-frequency">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Overview Card -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            Portfolio Overview
                            <span class="help-icon-css-orange"
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   title="<strong>Your Portfolio Dashboard</strong><br/>
                                          Complete overview of your cryptocurrency portfolio and trading strategy.<br/>
                                          <br/>
                                          <strong>Portfolio Value:</strong> Total EUR value with profit/loss tracking<br/>
                                          <strong>AI-First Strategy:</strong> Smart limits with minimum balances and safety thresholds<br/>
                                          <strong>Current Allocation:</strong> Real-time distribution across BTC, ETH, SOL, and EUR<br/>
                                          <strong>Visual Chart:</strong> Interactive allocation chart with percentages and values<br/>
                                          <br/>
                                          <em>Shows live portfolio status with AI-driven trading approach rather than rigid rebalancing.</em>">
                            </span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="portfolio-value" id="total-value">€0.00</div>
                        <div class="mb-3" id="portfolio-change">
                            <div class="row text-center">
                                <div class="col-3">
                                    <small class="text-muted d-block">1h</small>
                                    <span id="change-1h" class="text-muted">
                                        <i class="fas fa-minus"></i> 0.00%
                                    </span>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted d-block">4h</small>
                                    <span id="change-4h" class="text-muted">
                                        <i class="fas fa-minus"></i> 0.00%
                                    </span>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted d-block">24h</small>
                                    <span id="change-24h" class="text-muted">
                                        <i class="fas fa-minus"></i> 0.00%
                                    </span>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted d-block">5d</small>
                                    <span id="change-5d" class="text-muted">
                                        <i class="fas fa-minus"></i> 0.00%
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Balance Status Section -->
                        <!-- Smart Trading Strategy Section -->
                        <div class="rebalancing-section mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    AI-First Trading Strategy
                                </h6>
                                <span class="badge bg-success" id="trading-strategy-badge">
                                    <i class="fas fa-brain me-1"></i>
                                    AI-Driven
                                </span>
                            </div>
                            <div class="rebalance-status" id="trading-strategy-status">
                                <small class="text-muted">
                                    <span id="trading-strategy-text">AI decisions prioritized with smart safety limits</span>
                                </small>
                            </div>
                            <div class="rebalance-details mt-2" id="trading-strategy-details">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="metric-small">
                                            <div class="metric-value text-info">€50</div>
                                            <div class="metric-label">Min EUR</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="metric-small">
                                            <div class="metric-value text-warning">35%</div>
                                            <div class="metric-label">Max EUR</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="metric-small">
                                            <div class="metric-value text-success">3%</div>
                                            <div class="metric-label">Min Crypto</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="allocation-comparison">
                            <canvas id="allocationComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Overview & Recent Decisions Row -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            Market Overview & Recent Decisions
                            <span class="help-icon-css-orange"
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   title="<strong>Real-time Market Analysis</strong><br/>
                                          Shows current cryptocurrency prices and the AI's latest trading decisions.<br/>
                                          <br/>
                                          <strong>Current Prices:</strong> Live market prices from Coinbase<br/>
                                          <strong>Price Changes:</strong> Percentage changes over different time periods<br/>
                                          <strong>AI Decisions:</strong> Latest BUY/SELL/HOLD recommendations<br/>
                                          <strong>Confidence Levels:</strong> How confident the AI is in each decision (0-100%)<br/>
                                          <strong>Reasoning:</strong> Why the AI made each decision<br/>
                                          <br/>
                                          <em>The AI analyzes technical indicators, market trends, and risk factors to make decisions.</em>">
                            </span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3" id="market-decisions-data">
                            <!-- BTC Card -->
                            <div class="col-md-4" data-asset="BTC">
                                <div class="market-asset-card">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h4 class="mb-0">
                                            <strong>BTC</strong>
                                            <a href="https://www.coinbase.com/advanced-trade/spot/BTC-EUR" target="_blank" class="ms-2 coinbase-link">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </h4>
                                        <span class="decision-badge">
                                            <span class="badge bg-warning">HOLD</span>
                                        </span>
                                    </div>
                                    <div class="price-section mb-3">
                                        <div class="current-price">€0.00</div>
                                    </div>
                                    <div class="changes-grid mb-3">
                                        <div class="change-item">
                                            <div class="change-label">1h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">4h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">24h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">5d</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                    </div>
                                    <div class="decision-info">
                                        <div class="confidence mb-1">
                                            <span>Confidence: <span class="ai-confidence-value">0%</span></span>
                                            
                                        </div>
                                        <div class="decision-time text-muted mb-2">Last Update: <span class="time-value">--</span></div>
                                        
                                                                                <!-- Multi-Strategy Analysis -->
                                        <div class="multi-strategy-section mb-3" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; background: #f8f9fa;">
                                            <div class="strategy-header mb-2">
                                                <small class="text-muted"><i class="fas fa-chess-board me-1"></i>Multi-Strategy Analysis:</small>
                                                <span class="market-regime-badge badge bg-info ms-2">--</span>
                                            </div>
                                            
                                            <!-- Combined Signal -->
                                            <div class="combined-signal mb-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small><strong>Combined Signal:</strong></small>
                                                    <span class="combined-action-badge badge bg-secondary">--</span>
                                                </div>
                                                <div class="confidence-bar-container mt-1">
                                                    <div class="confidence-bar">
                                                        <div class="confidence-fill" style="width: 0%;"></div>
                                                    </div>
                                                    <small class="confidence-text">0%</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Individual Strategies -->
                                            <div class="individual-strategies" style="display: none;">
                                                <small class="text-muted d-block mb-1">Individual Strategy Signals:</small>
                                                <div class="strategy-signals">
                                                    <div class="strategy-signal" data-strategy="trend_following">
                                                        <span class="strategy-name">Trend Following:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                    <div class="strategy-signal" data-strategy="mean_reversion">
                                                        <span class="strategy-name">Mean Reversion:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                    <div class="strategy-signal" data-strategy="momentum">
                                                        <span class="strategy-name">Momentum:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Expand/Collapse Button -->
                                            <button class="btn btn-sm btn-outline-secondary mt-2 expand-strategies" type="button">
                                                <i class="fas fa-chevron-down me-1"></i>Show Strategy Details
                                            </button>
                                        </div>

                                        

                                        <div class="enhanced-decision-section">
                                            <!-- AI Analysis Summary -->
                                            <div class="ai-summary mb-2">
                                                <div class="ai-recommendation">
                                                    <small class="text-muted">AI Recommendation:</small>
                                                    <span class="ai-rec-badge badge bg-secondary">--</span>
                                                    <span class="threshold-check ms-1">
                                                        <i class="fas fa-check-circle text-success" title="Confidence threshold passed" style="display: none;"></i>
                                                        <i class="fas fa-times-circle text-danger" title="Confidence threshold not met" style="display: none;"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Technical Indicators -->
                                            <div class="technical-indicators mb-2" style="display: none;">
                                                <small class="text-muted d-block mb-1">Technical Analysis: <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.7rem;"></i><span class="tooltiptext"><h6>Technical Analysis Indicators</h6>Key technical indicators used by the AI for decision making:<ul><li><strong>RSI:</strong> Relative Strength Index (0-100) - measures overbought/oversold conditions</li><li><strong>MACD:</strong> Moving Average Convergence Divergence - trend momentum indicator</li><li><strong>BB:</strong> Bollinger Bands - volatility and price level indicator</li></ul><div class="example">RSI > 70 = Overbought, RSI < 30 = Oversold</div></span></span></small>
                                                <div class="indicators-row">
                                                    <span class="indicator-item">
                                                        <small>RSI:</small> <span class="rsi-value">--</span>
                                                    </span>
                                                    <span class="indicator-item">
                                                        <small>MACD:</small> <span class="macd-signal">--</span>
                                                    </span>
                                                    <span class="indicator-item">
                                                        <small>BB:</small> <span class="bb-signal">--</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Risk Management -->
                                            <div class="risk-management mb-2" style="display: none;">
                                                <small class="text-muted">Market Risk Management: <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.7rem;"></i><span class="tooltiptext"><h6>Market Risk Management System</h6>The AI applies sophisticated risk management to protect your portfolio:<ul><li><strong>Position Sizing:</strong> Adjusts trade amounts based on market volatility</li><li><strong>Risk Level:</strong> Low/Medium/High classification based on market conditions</li><li><strong>Confidence Threshold:</strong> Only executes trades above minimum confidence level</li></ul><div class="example">Higher risk = smaller position sizes for protection</div></span></span></small>
                                                <span class="risk-level-badge badge bg-info">--</span>
                                                <span class="position-size ms-1">
                                                    <small class="text-muted">Reduction Size: <span class="size-multiplier">100%</span><span class="help-icon-css" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Position Size Reduction</strong><br/>How much the bot reduces trade sizes based on market risk:<br/><br/><strong>100%</strong> = Normal full position size (low market risk)<br/><strong>75%</strong> = Reduced to 75% of normal size (medium risk)<br/><strong>50%</strong> = Reduced to 50% of normal size (high risk)<br/><br/><em>Example: If bot wants to trade €200, at 50% it only trades €100</em>" style="font-size: 0.6rem; margin-left: 4px;"></span></small>
                                                </span>
                                            </div>
                                            
                                            <!-- Reasoning Section -->
                                            <div class="reasoning-section">
                                                <button class="btn btn-link btn-sm p-0 expand-button">Show detailed analysis</button>
                                                
                                                <!-- Detailed Analysis (Hidden by default) -->
                                                <div class="detailed-analysis">
                                                    <div class="analysis-section">
                                                        <h6>AI Detailed Reasoning</h6>
                                                        <ul class="analysis-list ai-reasoning-list">
                                                            <li><strong>Trend Following:</strong> Weak trend (strength: 0.65) or unclear direction</li><li><strong>Mean Reversion:</strong> No clear mean reversion signal: RSI neutral at 56.7, Price near middle band (0.7% from center)</li><li><strong>Momentum:</strong> Weak momentum: Price momentum: 1h=0.2%, 4h=-0.1%, 24h=1.8%</li><li><strong>Llm Strategy:</strong> Enhanced LLM analysis: ['The Bollinger Band width is 1.11%, which is significantly below the 2% threshold, indicating a low-volatility squeeze and an impending breakout.', 'The current price position is 0.51, placing it directly in the neutral zone (0.4-0.6) of the 4-hour Bollinger Bands, suggesting no immediate directional edge for a day trade.', 'While MACD shows bullish momentum with a positive histogram and the price is above the VWAP, the neutral RSI (56.7) and Stochastic RSI (54.2) suggest a period of consolidation before a clear trend emerges.']; News sentiment: bullish (+0.37) from 3 articles, neutral impact</li>
                                                        </ul>
                                                    </div>
                                                    
                                                    <div class="analysis-section">
                                                        <h6>Bot Decision Logic <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.8rem;"></i><span class="tooltiptext"><h6>AI Decision Making Process</h6>Shows how the bot processes AI recommendations:<ul><li><strong>Confidence Check:</strong> Verifies AI confidence meets minimum threshold</li><li><strong>Risk Assessment:</strong> Evaluates market conditions and portfolio risk</li><li><strong>Final Decision:</strong> Combines AI analysis with risk management rules</li></ul><div class="example">Bot may override AI recommendations if risk is too high</div></span></span></h6>
                                                        <ul class="analysis-list bot-logic-list">
                                                            <li class="threshold-info">Confidence threshold check: Confidence 85.48888888900306% meets threshold (70%)</li>
                                                            <li class="risk-info">Risk management applied: Risk level: Ranging</li>
                                                            <li class="final-reason">Final decision reason: Final decision: HOLD based on combined analysis</li>
                                                        </ul>
                                                    </div>
                                                    
                                                    <div class="analysis-section">
                                                        <h6>Execution Context</h6>
                                                        <ul class="analysis-list execution-context-list">
                                                            <li class="data-quality">Market data quality: Good</li>
                                                            <li class="analysis-duration">Analysis duration: 0.00ms</li>
                                                            <li class="model-used">Analysis model: Multi-Strategy Analysis</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ETH Card -->
                            <div class="col-md-4" data-asset="ETH">
                                <div class="market-asset-card">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h4 class="mb-0">
                                            <strong>ETH</strong>
                                            <a href="https://www.coinbase.com/advanced-trade/spot/ETH-EUR" target="_blank" class="ms-2 coinbase-link">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </h4>
                                        <span class="decision-badge">
                                            <span class="badge bg-warning">HOLD</span>
                                        </span>
                                    </div>
                                    <div class="price-section mb-3">
                                        <div class="current-price">€0.00</div>
                                    </div>
                                    <div class="changes-grid mb-3">
                                        <div class="change-item">
                                            <div class="change-label">1h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">4h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">24h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">5d</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                    </div>
                                    <div class="decision-info">
                                        <div class="confidence mb-1">
                                            <span>Confidence: <span class="ai-confidence-value">0%</span></span>
                                            
                                        </div>
                                        <div class="decision-time text-muted mb-2">Last Update: <span class="time-value">--</span></div>
                                        
                                                                                <!-- Multi-Strategy Analysis -->
                                        <div class="multi-strategy-section mb-3" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; background: #f8f9fa;">
                                            <div class="strategy-header mb-2">
                                                <small class="text-muted"><i class="fas fa-chess-board me-1"></i>Multi-Strategy Analysis:</small>
                                                <span class="market-regime-badge badge bg-info ms-2">--</span>
                                            </div>
                                            
                                            <!-- Combined Signal -->
                                            <div class="combined-signal mb-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small><strong>Combined Signal:</strong></small>
                                                    <span class="combined-action-badge badge bg-secondary">--</span>
                                                </div>
                                                <div class="confidence-bar-container mt-1">
                                                    <div class="confidence-bar">
                                                        <div class="confidence-fill" style="width: 0%;"></div>
                                                    </div>
                                                    <small class="confidence-text">0%</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Individual Strategies -->
                                            <div class="individual-strategies" style="display: none;">
                                                <small class="text-muted d-block mb-1">Individual Strategy Signals:</small>
                                                <div class="strategy-signals">
                                                    <div class="strategy-signal" data-strategy="trend_following">
                                                        <span class="strategy-name">Trend Following:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                    <div class="strategy-signal" data-strategy="mean_reversion">
                                                        <span class="strategy-name">Mean Reversion:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                    <div class="strategy-signal" data-strategy="momentum">
                                                        <span class="strategy-name">Momentum:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Expand/Collapse Button -->
                                            <button class="btn btn-sm btn-outline-secondary mt-2 expand-strategies" type="button">
                                                <i class="fas fa-chevron-down me-1"></i>Show Strategy Details
                                            </button>
                                        </div>

                                        

                                        <div class="enhanced-decision-section">
                                            <!-- AI Analysis Summary -->
                                            <div class="ai-summary mb-2">
                                                <div class="ai-recommendation">
                                                    <small class="text-muted">AI Recommendation:</small>
                                                    <span class="ai-rec-badge badge bg-secondary">--</span>
                                                    <span class="threshold-check ms-1">
                                                        <i class="fas fa-check-circle text-success" title="Confidence threshold passed" style="display: none;"></i>
                                                        <i class="fas fa-times-circle text-danger" title="Confidence threshold not met" style="display: none;"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Technical Indicators -->
                                            <div class="technical-indicators mb-2" style="display: none;">
                                                <small class="text-muted d-block mb-1">Technical Analysis: <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.7rem;"></i><span class="tooltiptext"><h6>Technical Analysis Indicators</h6>Key technical indicators used by the AI for decision making:<ul><li><strong>RSI:</strong> Relative Strength Index (0-100) - measures overbought/oversold conditions</li><li><strong>MACD:</strong> Moving Average Convergence Divergence - trend momentum indicator</li><li><strong>BB:</strong> Bollinger Bands - volatility and price level indicator</li></ul><div class="example">RSI > 70 = Overbought, RSI < 30 = Oversold</div></span></span></small>
                                                <div class="indicators-row">
                                                    <span class="indicator-item">
                                                        <small>RSI:</small> <span class="rsi-value">--</span>
                                                    </span>
                                                    <span class="indicator-item">
                                                        <small>MACD:</small> <span class="macd-signal">--</span>
                                                    </span>
                                                    <span class="indicator-item">
                                                        <small>BB:</small> <span class="bb-signal">--</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Risk Management -->
                                            <div class="risk-management mb-2" style="display: none;">
                                                <small class="text-muted">Market Risk Management: <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.7rem;"></i><span class="tooltiptext"><h6>Market Risk Management System</h6>The AI applies sophisticated risk management to protect your portfolio:<ul><li><strong>Position Sizing:</strong> Adjusts trade amounts based on market volatility</li><li><strong>Risk Level:</strong> Low/Medium/High classification based on market conditions</li><li><strong>Confidence Threshold:</strong> Only executes trades above minimum confidence level</li></ul><div class="example">Higher risk = smaller position sizes for protection</div></span></span></small>
                                                <span class="risk-level-badge badge bg-info">--</span>
                                                <span class="position-size ms-1">
                                                    <small class="text-muted">Reduction Size: <span class="size-multiplier">100%</span><span class="help-icon-css" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Position Size Reduction</strong><br/>How much the bot reduces trade sizes based on market risk:<br/><br/><strong>100%</strong> = Normal full position size (low market risk)<br/><strong>75%</strong> = Reduced to 75% of normal size (medium risk)<br/><strong>50%</strong> = Reduced to 50% of normal size (high risk)<br/><br/><em>Example: If bot wants to trade €200, at 50% it only trades €100</em>" style="font-size: 0.6rem; margin-left: 4px;"></span></small>
                                                </span>
                                            </div>
                                            
                                            <!-- Reasoning Section -->
                                            <div class="reasoning-section">
                                                <button class="btn btn-link btn-sm p-0 expand-button">Show detailed analysis</button>
                                                
                                                <!-- Detailed Analysis (Hidden by default) -->
                                                <div class="detailed-analysis">
                                                    <div class="analysis-section">
                                                        <h6>AI Detailed Reasoning</h6>
                                                        <ul class="analysis-list ai-reasoning-list">
                                                            <li><strong>Trend Following:</strong> Weak trend (strength: 0.50) or unclear direction</li><li><strong>Mean Reversion:</strong> No clear mean reversion signal: RSI neutral at 53.3, Price near middle band (5.8% from center)</li><li><strong>Momentum:</strong> Weak momentum: Price momentum: 1h=0.2%, 4h=-0.1%, 24h=1.9%</li><li><strong>Llm Strategy:</strong> Enhanced LLM analysis: ['Bollinger Band width is currently 1.07%, which is significantly below the 2% threshold, indicating a low-volatility squeeze and an impending breakout.', 'The price is positioned at 0.56 relative to the Bollinger Bands, placing it in the neutral zone and very close to the middle band ($2516.03), suggesting a lack of immediate directional bias.', 'While the MACD shows bullish momentum and the price is above the VWAP ($2499.55), the neutral RSI of 53.3 and the Stochastic RSI of 61.8 suggest that the current trend lacks the strength required for a high-probability intraday entry.']; News sentiment: bullish (+0.70) from 2 articles, confidence +1.3</li>
                                                        </ul>
                                                    </div>
                                                    
                                                    <div class="analysis-section">
                                                        <h6>Bot Decision Logic <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.8rem;"></i><span class="tooltiptext"><h6>AI Decision Making Process</h6>Shows how the bot processes AI recommendations:<ul><li><strong>Confidence Check:</strong> Verifies AI confidence meets minimum threshold</li><li><strong>Risk Assessment:</strong> Evaluates market conditions and portfolio risk</li><li><strong>Final Decision:</strong> Combines AI analysis with risk management rules</li></ul><div class="example">Bot may override AI recommendations if risk is too high</div></span></span></h6>
                                                        <ul class="analysis-list bot-logic-list">
                                                            <li class="threshold-info">Confidence threshold check: Confidence 81.26818181819954% meets threshold (70%)</li>
                                                            <li class="risk-info">Risk management applied: Risk level: Ranging</li>
                                                            <li class="final-reason">Final decision reason: Final decision: HOLD based on combined analysis</li>
                                                        </ul>
                                                    </div>
                                                    
                                                    <div class="analysis-section">
                                                        <h6>Execution Context</h6>
                                                        <ul class="analysis-list execution-context-list">
                                                            <li class="data-quality">Market data quality: Good</li>
                                                            <li class="analysis-duration">Analysis duration: 0.00ms</li>
                                                            <li class="model-used">Analysis model: Multi-Strategy Analysis</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SOL Card -->
                            <div class="col-md-4" data-asset="SOL">
                                <div class="market-asset-card">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h4 class="mb-0">
                                            <strong>SOL</strong>
                                            <a href="https://www.coinbase.com/advanced-trade/spot/SOL-EUR" target="_blank" class="ms-2 coinbase-link">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </h4>
                                        <span class="decision-badge">
                                            <span class="badge bg-warning">HOLD</span>
                                        </span>
                                    </div>
                                    <div class="price-section mb-3">
                                        <div class="current-price">€0.00</div>
                                    </div>
                                    <div class="changes-grid mb-3">
                                        <div class="change-item">
                                            <div class="change-label">1h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">4h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">24h</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                        <div class="change-item">
                                            <div class="change-label">5d</div>
                                            <div class="change-value text-success">+0.00%</div>
                                        </div>
                                    </div>
                                    <div class="decision-info">
                                        <div class="confidence mb-1">
                                            <span>Confidence: <span class="ai-confidence-value">0%</span></span>
                                            
                                        </div>
                                        <div class="decision-time text-muted mb-2">Last Update: <span class="time-value">--</span></div>
                                        
                                                                                <!-- Multi-Strategy Analysis -->
                                        <div class="multi-strategy-section mb-3" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; background: #f8f9fa;">
                                            <div class="strategy-header mb-2">
                                                <small class="text-muted"><i class="fas fa-chess-board me-1"></i>Multi-Strategy Analysis:</small>
                                                <span class="market-regime-badge badge bg-info ms-2">--</span>
                                            </div>
                                            
                                            <!-- Combined Signal -->
                                            <div class="combined-signal mb-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small><strong>Combined Signal:</strong></small>
                                                    <span class="combined-action-badge badge bg-secondary">--</span>
                                                </div>
                                                <div class="confidence-bar-container mt-1">
                                                    <div class="confidence-bar">
                                                        <div class="confidence-fill" style="width: 0%;"></div>
                                                    </div>
                                                    <small class="confidence-text">0%</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Individual Strategies -->
                                            <div class="individual-strategies" style="display: none;">
                                                <small class="text-muted d-block mb-1">Individual Strategy Signals:</small>
                                                <div class="strategy-signals">
                                                    <div class="strategy-signal" data-strategy="trend_following">
                                                        <span class="strategy-name">Trend Following:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                    <div class="strategy-signal" data-strategy="mean_reversion">
                                                        <span class="strategy-name">Mean Reversion:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                    <div class="strategy-signal" data-strategy="momentum">
                                                        <span class="strategy-name">Momentum:</span>
                                                        <span class="strategy-action badge bg-secondary">--</span>
                                                        <span class="strategy-confidence">--</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Expand/Collapse Button -->
                                            <button class="btn btn-sm btn-outline-secondary mt-2 expand-strategies" type="button">
                                                <i class="fas fa-chevron-down me-1"></i>Show Strategy Details
                                            </button>
                                        </div>

                                        

                                        <div class="enhanced-decision-section">
                                            <!-- AI Analysis Summary -->
                                            <div class="ai-summary mb-2">
                                                <div class="ai-recommendation">
                                                    <small class="text-muted">AI Recommendation:</small>
                                                    <span class="ai-rec-badge badge bg-secondary">--</span>
                                                    <span class="threshold-check ms-1">
                                                        <i class="fas fa-check-circle text-success" title="Confidence threshold passed" style="display: none;"></i>
                                                        <i class="fas fa-times-circle text-danger" title="Confidence threshold not met" style="display: none;"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Technical Indicators -->
                                            <div class="technical-indicators mb-2" style="display: none;">
                                                <small class="text-muted d-block mb-1">Technical Analysis: <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.7rem;"></i><span class="tooltiptext"><h6>Technical Analysis Indicators</h6>Key technical indicators used by the AI for decision making:<ul><li><strong>RSI:</strong> Relative Strength Index (0-100) - measures overbought/oversold conditions</li><li><strong>MACD:</strong> Moving Average Convergence Divergence - trend momentum indicator</li><li><strong>BB:</strong> Bollinger Bands - volatility and price level indicator</li></ul><div class="example">RSI > 70 = Overbought, RSI < 30 = Oversold</div></span></span></small>
                                                <div class="indicators-row">
                                                    <span class="indicator-item">
                                                        <small>RSI:</small> <span class="rsi-value">--</span>
                                                    </span>
                                                    <span class="indicator-item">
                                                        <small>MACD:</small> <span class="macd-signal">--</span>
                                                    </span>
                                                    <span class="indicator-item">
                                                        <small>BB:</small> <span class="bb-signal">--</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Risk Management -->
                                            <div class="risk-management mb-2" style="display: none;">
                                                <small class="text-muted">Market Risk Management: <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.7rem;"></i><span class="tooltiptext"><h6>Market Risk Management System</h6>The AI applies sophisticated risk management to protect your portfolio:<ul><li><strong>Position Sizing:</strong> Adjusts trade amounts based on market volatility</li><li><strong>Risk Level:</strong> Low/Medium/High classification based on market conditions</li><li><strong>Confidence Threshold:</strong> Only executes trades above minimum confidence level</li></ul><div class="example">Higher risk = smaller position sizes for protection</div></span></span></small>
                                                <span class="risk-level-badge badge bg-info">--</span>
                                                <span class="position-size ms-1">
                                                    <small class="text-muted">Reduction Size: <span class="size-multiplier">100%</span><span class="help-icon-css" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<strong>Position Size Reduction</strong><br/>How much the bot reduces trade sizes based on market risk:<br/><br/><strong>100%</strong> = Normal full position size (low market risk)<br/><strong>75%</strong> = Reduced to 75% of normal size (medium risk)<br/><strong>50%</strong> = Reduced to 50% of normal size (high risk)<br/><br/><em>Example: If bot wants to trade €200, at 50% it only trades €100</em>" style="font-size: 0.6rem; margin-left: 4px;"></span></small>
                                                </span>
                                            </div>
                                            
                                            <!-- Reasoning Section -->
                                            <div class="reasoning-section">
                                                <button class="btn btn-link btn-sm p-0 expand-button">Show detailed analysis</button>
                                                
                                                <!-- Detailed Analysis (Hidden by default) -->
                                                <div class="detailed-analysis">
                                                    <div class="analysis-section">
                                                        <h6>AI Detailed Reasoning</h6>
                                                        <ul class="analysis-list ai-reasoning-list">
                                                            <li><strong>Trend Following:</strong> Strong uptrend detected (strength: 0.65), RSI not overbought</li><li><strong>Mean Reversion:</strong> No clear mean reversion signal: RSI neutral at 62.8, Price near middle band (18.3% from center)</li><li><strong>Momentum:</strong> Weak momentum: Price momentum: 1h=0.2%, 4h=-0.5%, 24h=3.4%</li><li><strong>Llm Strategy:</strong> Enhanced LLM analysis: Error during analysis: 400 Client Error: Bad Request for url: https://us-central1-aiplatform.googleapis.com/v1/projects/intense-base-456414-u5/locations/us-central1/publishers/google/models/gemini-2.0-flash-exp:generateContent; News sentiment: bullish (+0.45) from 2 articles, confidence +0.7</li>
                                                        </ul>
                                                    </div>
                                                    
                                                    <div class="analysis-section">
                                                        <h6>Bot Decision Logic <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.8rem;"></i><span class="tooltiptext"><h6>AI Decision Making Process</h6>Shows how the bot processes AI recommendations:<ul><li><strong>Confidence Check:</strong> Verifies AI confidence meets minimum threshold</li><li><strong>Risk Assessment:</strong> Evaluates market conditions and portfolio risk</li><li><strong>Final Decision:</strong> Combines AI analysis with risk management rules</li></ul><div class="example">Bot may override AI recommendations if risk is too high</div></span></span></h6>
                                                        <ul class="analysis-list bot-logic-list">
                                                            <li class="threshold-info">Confidence threshold check: Confidence 74.0% meets threshold (70%)</li>
                                                            <li class="risk-info">Risk management applied: Risk level: Trending</li>
                                                            <li class="final-reason">Final decision reason: Final decision: BUY based on combined analysis</li>
                                                        </ul>
                                                    </div>
                                                    
                                                    <div class="analysis-section">
                                                        <h6>Execution Context</h6>
                                                        <ul class="analysis-list execution-context-list">
                                                            <li class="data-quality">Market data quality: Good</li>
                                                            <li class="analysis-duration">Analysis duration: 0.00ms</li>
                                                            <li class="model-used">Analysis model: Multi-Strategy Analysis</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>

        <!-- Trading History Row -->
        <div class="row g-4">
            <!-- Trading History Card -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#trade-history">
                                    Trade History
                                    <span class="help-icon-css"
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           data-bs-html="true"
                                           title="<strong>Complete Trading Activity Log</strong><br/>
                                                  Shows all trading decisions and executions made by the AI bot.<br/>
                                                  <br/>
                                                  <strong>Actions:</strong> BUY (green), SELL (red), HOLD (gray)<br/>
                                                  <strong>Confidence:</strong> AI's certainty level (0-100%)<br/>
                                                  <strong>Reasoning:</strong> Why the AI made each decision<br/>
                                                  <strong>Show Details:</strong> Click to see comprehensive trade information<br/>
                                                  <strong>Filters:</strong> Filter by asset, action, or time period<br/>
                                                  <br/>
                                                  <em>Use filters to analyze specific trading patterns or time periods.</em>">
                                    </span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="trade-history">
                                <div class="filter-controls mb-3">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                Asset
                                                <span class="tooltip">
                                                    <i class="fas fa-question-circle help-icon"></i>
                                                    <span class="tooltiptext">
                                                        <h6>Asset Filter</h6>
                                                        Filter trades by specific cryptocurrency.
                                                        <ul>
                                                            <li><strong>All:</strong> Show trades for all assets</li>
                                                            <li><strong>BTC:</strong> Bitcoin trades only</li>
                                                            <li><strong>ETH:</strong> Ethereum trades only</li>
                                                            <li><strong>SOL:</strong> Solana trades only</li>
                                                        </ul>
                                                        <div class="example">Use this to analyze the bot's performance with specific cryptocurrencies.</div>
                                                    </span>
                                                </span>
                                            </label>
                                            <select class="form-select bg-dark text-light" id="asset-filter">
                                                <option value="">All</option>
                                                <option value="BTC">BTC</option>
                                                <option value="ETH">ETH</option>
                                                <option value="SOL">SOL</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                Action
                                                <span class="tooltip">
                                                    <i class="fas fa-question-circle help-icon"></i>
                                                    <span class="tooltiptext">
                                                        <h6>Action Filter</h6>
                                                        Filter trades by the type of action taken.
                                                        <ul>
                                                            <li><strong>All:</strong> Show all trading actions</li>
                                                            <li><strong>Buy:</strong> Only purchase orders</li>
                                                            <li><strong>Sell:</strong> Only sell orders</li>
                                                            <li><strong>Hold:</strong> No-action decisions</li>
                                                        </ul>
                                                        <div class="example">Use this to analyze specific trading behaviors or strategies.</div>
                                                    </span>
                                                </span>
                                            </label>
                                            <select class="form-select bg-dark text-light" id="action-filter">
                                                <option value="">All</option>
                                                <option value="BUY">Buy</option>
                                                <option value="SELL">Sell</option>
                                                <option value="HOLD">Hold</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                Time Period
                                                <span class="tooltip">
                                                    <i class="fas fa-question-circle help-icon"></i>
                                                    <span class="tooltiptext">
                                                        <h6>Time Period Filter</h6>
                                                        Filter trades by when they occurred.
                                                        <ul>
                                                            <li><strong>Last 6 Hours:</strong> Most recent activity</li>
                                                            <li><strong>Last 24 Hours:</strong> Today's trading</li>
                                                            <li><strong>Last 7 Days:</strong> This week's activity</li>
                                                            <li><strong>Last 30 Days:</strong> This month's trading</li>
                                                            <li><strong>All Time:</strong> Complete trading history</li>
                                                        </ul>
                                                        <div class="example">Use shorter periods to analyze recent performance trends.</div>
                                                    </span>
                                                </span>
                                            </label>
                                            <select class="form-select bg-dark text-light" id="time-filter">
                                                <option value="6h" selected>Last 6 Hours</option>
                                                <option value="24h">Last 24 Hours</option>
                                                <option value="7d">Last 7 Days</option>
                                                <option value="30d">Last 30 Days</option>
                                                <option value="all">All Time</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                Sort By
                                                <span class="tooltip">
                                                    <i class="fas fa-question-circle help-icon"></i>
                                                    <span class="tooltiptext">
                                                        <h6>Sort Order</h6>
                                                        Choose how to order the trade history.
                                                        <ul>
                                                            <li><strong>Time (Newest):</strong> Most recent trades first</li>
                                                            <li><strong>Time (Oldest):</strong> Oldest trades first</li>
                                                            <li><strong>Amount (Highest):</strong> Largest trades first</li>
                                                            <li><strong>Amount (Lowest):</strong> Smallest trades first</li>
                                                        </ul>
                                                        <div class="example">Sort by amount to identify the bot's largest trading decisions.</div>
                                                    </span>
                                                </span>
                                            </label>
                                            <select class="form-select bg-dark text-light" id="sort-filter">
                                                <option value="time-desc">Time (Newest)</option>
                                                <option value="time-asc">Time (Oldest)</option>
                                                <option value="amount-desc">Amount (Highest)</option>
                                                <option value="amount-asc">Amount (Lowest)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>
                                                    Time
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>Trade Timestamp</strong><br/>
                                                                  When the AI made this trading decision.<br/>
                                                                  <em>All times shown in UTC (24-hour format)</em>"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                                <th>
                                                    Action
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>Trading Action</strong><br/>
                                                                  What the AI decided to do.<br/>
                                                                  <br/>
                                                                  <strong>BUY:</strong> Purchase cryptocurrency<br/>
                                                                  <strong>SELL:</strong> Sell cryptocurrency<br/>
                                                                  <strong>HOLD:</strong> No action taken"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                                <th>
                                                    Asset
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>Cryptocurrency Asset</strong><br/>
                                                                  Which cryptocurrency was analyzed.<br/>
                                                                  <br/>
                                                                  <strong>BTC:</strong> Bitcoin<br/>
                                                                  <strong>ETH:</strong> Ethereum<br/>
                                                                  <strong>SOL:</strong> Solana"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                                <th>
                                                    Amount
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>Crypto Amount</strong><br/>
                                                                  How much cryptocurrency was traded.<br/>
                                                                  <br/>
                                                                  <em>Shown with 8 decimal places for precision.<br/>
                                                                  0.00000000 means HOLD (no trade).</em>"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                                <th>
                                                    Price
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>Execution Price</strong><br/>
                                                                  The price per unit when the trade was executed.<br/>
                                                                  <br/>
                                                                  <em>For HOLD decisions, this shows the current<br/>
                                                                  market price at decision time.</em>"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                                <th>
                                                    Total
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>Total EUR Value</strong><br/>
                                                                  Total EUR amount of the trade.<br/>
                                                                  <br/>
                                                                  <em>Amount × Price = Total EUR value.<br/>
                                                                  €0.00 for HOLD decisions.</em>"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                                <th>
                                                    Fees
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>Trading Fees</strong><br/>
                                                                  Fees charged by Coinbase for the trade.<br/>
                                                                  <br/>
                                                                  <em>Shows both absolute amount (€) and percentage (%).<br/>
                                                                  €0.00 (0.000%) for HOLD decisions.</em>"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                                <th>
                                                    Confidence
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>Confidence Level</strong><br/>
                                                                  How confident the AI was in this decision (0-100%).<br/>
                                                                  <br/>
                                                                  <strong>80-100%:</strong> Very confident<br/>
                                                                  <strong>60-79%:</strong> Moderately confident<br/>
                                                                  <strong>40-59%:</strong> Low confidence<br/>
                                                                  <strong>0-39%:</strong> Very uncertain"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                                <th>
                                                    Reasoning
                                                    <span class="help-icon-css"
                                                           data-bs-toggle="tooltip" 
                                                           data-bs-placement="top" 
                                                           data-bs-html="true"
                                                           title="<strong>AI Decision Reasoning</strong><br/>
                                                                  Why the AI made this decision.<br/>
                                                                  <br/>
                                                                  <em>Click 'Show Details' to see comprehensive analysis<br/>
                                                                  including technical indicators, market conditions,<br/>
                                                                  and risk assessment.</em>"
                                                           style="font-size: 0.7rem; opacity: 0.7; cursor: help;">
                                                    </span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="trade-history-data">
                                            <!-- Trade history will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for performance charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Multi-Strategy JavaScript -->
    <script src="multi-strategy.js"></script>
    <script>
        // Safe number formatting functions
        function safeToFixed(value, decimals = 2) {
            const num = parseFloat(value);
            return isNaN(num) ? '0.00' : num.toFixed(decimals);
        }
        
        function safeNumber(value, defaultValue = 0) {
            const num = parseFloat(value);
            return isNaN(num) ? defaultValue : num;
        }
        
        function formatCurrency(value) {
            return '€' + safeToFixed(value, 2);
        }
        
        function formatPercentage(value, decimals = 2) {
            const num = safeNumber(value);
            return (num >= 0 ? '+' : '') + safeToFixed(num, decimals) + '%';
        }

        // Function to load data
        async function loadData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                
                // Handle text files (like last_updated.txt)
                if (url.endsWith('.txt')) {
                    return await response.text();
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error loading data:', error);
                return null;
            }
        }

        // Function to load detailed analysis files (silently handles 404s)
        async function loadDetailedAnalysisData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    // Silently return null for 404s (file doesn't exist)
                    if (response.status === 404) {
                        return null;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                // Silently handle all errors for detailed analysis files
                return null;
            }
        }

        // Cache for available detailed analysis files
        let availableAnalysisFiles = null;

        // Function to get list of available detailed analysis files
        async function getAvailableAnalysisFiles() {
            if (availableAnalysisFiles !== null) {
                return availableAnalysisFiles;
            }

            try {
                // Try to load a manifest of available files if it exists
                const manifest = await loadData('./data/analysis_manifest.json');
                if (manifest && manifest.files) {
                    availableAnalysisFiles = new Set(manifest.files);
                    return availableAnalysisFiles;
                }
            } catch (error) {
                // Manifest doesn't exist, continue with fallback
            }

            // Fallback: assume no files are available to avoid 404s
            // This prevents unnecessary HTTP requests
            availableAnalysisFiles = new Set();
            return availableAnalysisFiles;
        }

        // Global variable to store countdown interval
        let countdownInterval = null;

        // Function to update bot status
        async function updateBotStatus() {
            const data = await loadData('./data/cache/bot_startup.json');
            const configData = await loadData('./data/config/config.json');
            const lastUpdated = await loadData('./data/cache/last_updated.txt');
            
            if (data) {
                // Update bot online/offline status
                const statusElement = document.getElementById('bot-status');
                const statusIndicator = document.querySelector('.status-indicator');
                
                if (data.status === 'offline') {
                    if (statusElement) {
                        statusElement.textContent = 'Offline';
                    }
                    if (statusIndicator) {
                        statusIndicator.className = 'status-indicator status-offline me-2';
                    }
                    
                    // Show shutdown time instead of uptime
                    const uptimeElement = document.getElementById('bot-uptime');
                    if (data.shutdown_time) {
                        const shutdownTime = new Date(data.shutdown_time + 'Z');
                        if (uptimeElement) {
                            uptimeElement.innerHTML = 
                                '<i class="fas fa-power-off me-1"></i>Stopped: ' + 
                                formatUTCTime(shutdownTime);
                        }
                    } else {
                        if (uptimeElement) {
                            uptimeElement.innerHTML = 
                                '<i class="fas fa-power-off me-1"></i>Status: Offline';
                        }
                    }
                    
                    // Clear countdown timer for offline bot
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                    const nextDecisionElement = document.getElementById('next-decision-timer');
                    if (nextDecisionElement) {
                        nextDecisionElement.textContent = 'Bot offline';
                    }
                    
                } else {
                    // Bot is online
                    if (statusElement) {
                        statusElement.textContent = 'Online';
                    }
                    if (statusIndicator) {
                        statusIndicator.className = 'status-indicator status-online me-2';
                    }
                    
                    // Use total uptime if available, otherwise fall back to session uptime
                    let uptimeSeconds;
                    let uptimeText = '';
                    
                    if (data.total_uptime_seconds !== undefined) {
                        // Calculate current session time
                        const sessionStart = new Date(data.startup_time + 'Z');
                        const currentSessionSeconds = Math.floor((new Date() - sessionStart) / 1000);
                        
                        // Total uptime is previous sessions + current session
                        uptimeSeconds = data.total_uptime_seconds + currentSessionSeconds;
                        
                        // Add restart count if available
                        if (data.restart_count > 0) {
                            uptimeText = `<i class="fas fa-history me-1"></i>Uptime: ${formatUptime(uptimeSeconds)} <small class="text-muted">(${data.restart_count} restarts)</small>`;
                        } else {
                            uptimeText = `<i class="fas fa-history me-1"></i>Uptime: ${formatUptime(uptimeSeconds)}`;
                        }
                    } else {
                        // Fallback to session uptime
                        const startTime = new Date(data.startup_time + 'Z');
                        uptimeSeconds = Math.floor((new Date() - startTime) / 1000);
                        uptimeText = `<i class="fas fa-history me-1"></i>Session: ${formatUptime(uptimeSeconds)}`;
                    }
                    
                    const uptimeElement = document.getElementById('bot-uptime');
                    if (uptimeElement) {
                        uptimeElement.innerHTML = uptimeText;
                    } else {
                        console.warn('bot-uptime element not found in DOM');
                    }

                    // Update next decision countdown
                    if (data.next_decision_time) {
                        const nextDecision = new Date(data.next_decision_time + 'Z'); // Ensure UTC
                        
                        if (nextDecision > new Date()) {
                            updateCountdown(nextDecision);
                        } else {
                            // Calculate next interval from last decision time
                            const lastDecision = new Date(data.last_decision_time + 'Z');
                            const intervalMs = (data.decision_interval_minutes || 60) * 60 * 1000;
                            const nextDecision = new Date(lastDecision.getTime() + intervalMs);
                            
                            if (nextDecision > new Date()) {
                                updateCountdown(nextDecision);
                            } else {
                                const nextDecisionElement = document.getElementById('next-decision-timer');
                                if (nextDecisionElement) {
                                    nextDecisionElement.textContent = 'Due now';
                                }
                            }
                        }
                    } else {
                        // Fallback: calculate next decision based on startup time and interval
                        const startTime = new Date(data.startup_time + 'Z');
                        const intervalMs = (data.decision_interval_minutes || 60) * 60 * 1000;
                        const nextDecision = new Date(startTime.getTime() + intervalMs);
                        updateCountdown(nextDecision);
                    }
                }
                
                // Update last trade time (from trade history)
                const tradeHistory = await loadData('./data/trades/trade_history.json');
                const lastUpdateElement = document.getElementById('last-update');
                if (tradeHistory && tradeHistory.length > 0) {
                    const lastTrade = tradeHistory[tradeHistory.length - 1];
                    const lastTradeTime = new Date(lastTrade.timestamp + 'Z');
                    if (lastUpdateElement) {
                        lastUpdateElement.innerHTML = 
                            `<i class="far fa-clock me-1"></i>${formatUTCTime(lastTradeTime)}`;
                    }
                } else if (data.last_decision_time) {
                    // Fallback to last decision time if no trades
                    const lastDecision = new Date(data.last_decision_time + 'Z');
                    if (lastUpdateElement) {
                        lastUpdateElement.innerHTML = 
                            `<i class="far fa-clock me-1"></i>${formatUTCTime(lastDecision)}`;
                    }
                } else {
                    if (lastUpdateElement) {
                        lastUpdateElement.innerHTML = 
                            `<i class="far fa-clock me-1"></i>No recent updates`;
                    }
                }
                
                // Update market data timestamp (from latest decision files)
                const btcMarketData = await loadData('./data/BTC_EUR_latest.json');
                const marketDataUpdateElement = document.getElementById('market-data-update');
                if (btcMarketData && btcMarketData.market_data && btcMarketData.market_data.timestamp) {
                    const marketDataTime = new Date(btcMarketData.market_data.timestamp + (btcMarketData.market_data.timestamp.includes('Z') ? '' : 'Z'));
                    if (marketDataUpdateElement) {
                        marketDataUpdateElement.innerHTML = 
                            `<i class="far fa-clock me-1"></i>${formatUTCTime(marketDataTime)}`;
                    }
                } else if (btcMarketData && btcMarketData.timestamp) {
                    // Fallback to decision timestamp if market_data timestamp not available
                    const decisionTime = new Date(btcMarketData.timestamp + (btcMarketData.timestamp.includes('Z') ? '' : 'Z'));
                    if (marketDataUpdateElement) {
                        marketDataUpdateElement.innerHTML = 
                            `<i class="far fa-clock me-1"></i>${formatUTCTime(decisionTime)}`;
                    }
                }
                
                // Update simulation mode badge
                const simulationBadge = document.querySelector('.simulation-badge');
                if (data.simulation_mode !== undefined && simulationBadge) {
                    if (data.simulation_mode) {
                        simulationBadge.textContent = 'SIMULATION';
                        simulationBadge.className = 'ms-2 badge simulation-badge simulation';
                    } else {
                        simulationBadge.textContent = 'LIVE TRADING';
                        simulationBadge.className = 'ms-2 badge simulation-badge live';
                    }
                } else if (simulationBadge) {
                    simulationBadge.textContent = 'UNKNOWN';
                    simulationBadge.className = 'ms-2 badge simulation-badge bg-secondary';
                }
                
                // Update bot risk level (static configuration)
                const riskLevel = document.getElementById('risk-level');
                if (data.risk_level && riskLevel) {
                    riskLevel.textContent = data.risk_level.toUpperCase();
                    riskLevel.className = `risk-${data.risk_level.toLowerCase()}`;
                } else if (riskLevel) {
                    riskLevel.textContent = 'UNKNOWN';
                    riskLevel.className = '';
                }
                
                // Update market volatility (dynamic assessment from config)
                const marketVolatility = document.getElementById('market-volatility');
                const volatilityFromConfig = configData?.market_volatility || 'unknown';
                if (volatilityFromConfig !== 'unknown' && marketVolatility) {
                    marketVolatility.textContent = volatilityFromConfig.toUpperCase();
                    marketVolatility.className = `volatility-${volatilityFromConfig.toLowerCase()}`;
                } else if (marketVolatility) {
                    // Fallback: try to get volatility from recent analysis data
                    marketVolatility.textContent = 'ANALYZING...';
                    marketVolatility.className = 'volatility-unknown';
                }
                
                // Update trading style
                const tradingStyle = document.getElementById('trading-style');
                if (data.trading_style && tradingStyle) {
                    const styleDisplay = data.trading_style.replace('_', ' ').toUpperCase();
                    tradingStyle.textContent = styleDisplay;
                    tradingStyle.className = `trading-style-${data.trading_style.toLowerCase()}`;
                } else if (tradingStyle) {
                    tradingStyle.textContent = 'DAY TRADING';
                    tradingStyle.className = 'trading-style-day-trading';
                }
                
                // Update decision frequency
                const decisionFreq = document.getElementById('decision-frequency');
                if (data.decision_interval_minutes && decisionFreq) {
                    decisionFreq.textContent = `Every ${data.decision_interval_minutes} minutes`;
                } else if (decisionFreq) {
                    decisionFreq.textContent = 'Every 60 minutes';
                }
            } else {
                // If no data available, show fallback
                const nextDecisionElement = document.getElementById('next-decision-timer');
                const lastUpdateElement = document.getElementById('last-update');
                
                if (nextDecisionElement) {
                    nextDecisionElement.textContent = 'Data unavailable';
                }
                if (lastUpdateElement) {
                    lastUpdateElement.innerHTML = 
                        `<i class="far fa-clock me-1"></i>Data unavailable`;
                }
            }
        }

        // Function to update countdown timer
        function updateCountdown(nextDecisionTime) {
            // Clear any existing interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            function updateTimer() {
                const now = new Date();
                const diff = nextDecisionTime - now;
                const nextDecisionElement = document.getElementById('next-decision-timer');
                
                if (diff <= 0) {
                    if (nextDecisionElement) {
                        nextDecisionElement.textContent = 'Due now';
                    }
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                    return;
                }

                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                if (nextDecisionElement) {
                    nextDecisionElement.textContent = 
                        `${minutes}m ${seconds}s`;
                }
            }

            // Update immediately
            updateTimer();
            
            // Set up interval to update every second
            countdownInterval = setInterval(updateTimer, 1000);
        }

        // Function to extract price changes from AI analysis text
        function extractPriceChangesFromText(aiReasoning) {
            const changes = {"1h": 0.0, "4h": 0.0, "24h": 0.0, "5d": 0.0};
            
            if (!aiReasoning || !Array.isArray(aiReasoning)) {
                return changes;
            }
            
            // Combine all reasoning text
            const fullText = aiReasoning.join(" ");
            
            // Patterns to match different time periods
            const patterns = {
                "24h": [
                    /24-hour change.*?([+-]?\d+\.?\d*)%/gi,
                    /24h change.*?([+-]?\d+\.?\d*)%/gi,
                    /daily change.*?([+-]?\d+\.?\d*)%/gi,
                    /(\d+\.?\d*)% increase in the last 24 hours/gi,
                    /(\d+\.?\d*)% decrease in the last 24 hours/gi,
                    /last 24 hours.*?([+-]?\d+\.?\d*)%/gi
                ],
                "5d": [
                    /7-day change.*?([+-]?\d+\.?\d*)%/gi,
                    /7d change.*?([+-]?\d+\.?\d*)%/gi,
                    /weekly change.*?([+-]?\d+\.?\d*)%/gi,
                    /5-day change.*?([+-]?\d+\.?\d*)%/gi,
                    /5d change.*?([+-]?\d+\.?\d*)%/gi,
                    /(\d+\.?\d*)% increase over the past 7 days/gi,
                    /(\d+\.?\d*)% decrease over the past 7 days/gi,
                    /past 7 days.*?([+-]?\d+\.?\d*)%/gi,
                    /7-day price change of (\d+\.?\d*)%/gi
                ]
            };
            
            // Extract changes using regex patterns
            for (const [period, patternList] of Object.entries(patterns)) {
                for (const pattern of patternList) {
                    const matches = fullText.match(pattern);
                    if (matches && matches.length > 0) {
                        try {
                            // Extract the number from the match
                            const numberMatch = matches[0].match(/([+-]?\d+\.?\d*)/);
                            if (numberMatch) {
                                let changeValue = parseFloat(numberMatch[1]);
                                
                                // Handle increase/decrease patterns
                                if (matches[0].toLowerCase().includes('decrease') && changeValue > 0) {
                                    changeValue = -changeValue;
                                }
                                
                                changes[period] = changeValue;
                                break; // Stop after first successful match for this period
                            }
                        } catch (e) {
                            console.warn(`Error parsing price change for ${period}:`, e);
                        }
                    }
                }
            }
            
            // Estimate 1h and 4h changes based on 24h data if available
            if (changes["24h"] !== 0.0) {
                // Rough estimation: assume linear distribution (not perfect but better than 0)
                // 1h ≈ 24h change / 24, 4h ≈ 24h change / 6
                changes["1h"] = parseFloat((changes["24h"] / 24).toFixed(2));
                changes["4h"] = parseFloat((changes["24h"] / 6).toFixed(2));
            }
            
            return changes;
        }

        // Function to update market data and recent decisions
        async function updateMarketData() {
            const assets = ['BTC', 'ETH', 'SOL'];
            const decisions = await loadData('./data/cache/latest_decisions.json');
            const tradingData = await loadData('./data/cache/trading_data.json');
            
            for (const asset of assets) {
                // Read from the latest individual decision file instead of market_data folder
                const marketData = await loadData(`./data/${asset}_EUR_latest.json`);
                const card = document.querySelector(`#market-decisions-data [data-asset="${asset}"]`);
                
                if (card) {
                    // Update price from individual decision file market_data section
                    if (marketData?.market_data?.price) {
                        const price = marketData.market_data.price;
                        const formattedPrice = `€${parseFloat(price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        card.querySelector('.current-price').textContent = formattedPrice;
                    } else if (tradingData?.market_data?.[`${asset}-EUR`]?.price) {
                        // Fallback to trading_data.json
                        const price = tradingData.market_data[`${asset}-EUR`].price;
                        const formattedPrice = `€${parseFloat(price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        card.querySelector('.current-price').textContent = formattedPrice;
                    } else {
                        card.querySelector('.current-price').textContent = '€0.00';
                    }
                    
                    // Update percentage changes from individual decision file
                    const timeframes = ['1h', '4h', '24h', '5d'];
                    const changeItems = card.querySelectorAll('.change-item');
                    
                    // Get price changes from multiple sources in priority order
                    let priceChanges = {"1h": 0.0, "4h": 0.0, "24h": 0.0, "5d": 0.0};
                    
                    // 1. Try individual decision file market_data section (NEW - best source)
                    if (marketData?.market_data?.price_changes) {
                        priceChanges = marketData.market_data.price_changes;
                    }
                    // 2. Fallback to trading_data.json market_data
                    else if (tradingData?.market_data?.[`${asset}-EUR`]?.price_changes) {
                        priceChanges = tradingData.market_data[`${asset}-EUR`].price_changes;
                    }
                    // 3. Final fallback: extract from AI analysis
                    else if (marketData?.ai_analysis?.detailed_reasoning) {
                        priceChanges = extractPriceChangesFromText(marketData.ai_analysis.detailed_reasoning);
                    }
                    
                    timeframes.forEach((timeframe, index) => {
                        if (changeItems[index]) {
                            const valueElement = changeItems[index].querySelector('.change-value');
                            
                            const change = priceChanges[timeframe] || 0;
                            
                            // Format and display the change
                            const formattedChange = formatPercentage(change);
                            valueElement.textContent = formattedChange;
                            
                            // Color code based on positive/negative
                            if (change > 0) {
                                valueElement.className = 'change-value text-success';
                            } else if (change < 0) {
                                valueElement.className = 'change-value text-danger';
                            } else {
                                valueElement.className = 'change-value text-muted';
                            }
                            
                        }
                    });
                }
                
                // Update decision data
                if (marketData) {
                    // Use the enhanced decision data from the individual decision file
                    updateEnhancedDecisionDisplay(card, marketData);
                } else if (decisions && Array.isArray(decisions)) {
                    // Fallback to basic decision data from latest_decisions.json
                    const latestDecision = decisions
                        .filter(d => d.asset === asset)
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                    
                    if (latestDecision) {
                        updateEnhancedDecisionDisplay(card, latestDecision);
                    }
                }
            }
        }

        // Function to update enhanced decision display
        function updateEnhancedDecisionDisplay(card, decision) {
            const action = decision.action.toUpperCase();
            
            // Update main decision badge (if exists)
            const badge = card.querySelector('.decision-badge .badge');
            if (badge) {
                badge.textContent = action;
                badge.className = `badge ${
                    action === 'BUY' ? 'bg-success' : 
                    action === 'SELL' ? 'bg-danger' : 
                    'bg-warning'
                }`;
            }
            
            // Update multi-strategy display if available
            if (decision.strategy_details && window.MultiStrategy) {
                const asset = decision.asset || card.getAttribute('data-asset');
                window.MultiStrategy.updateDisplay(asset, decision);
            }
            
            // Update confidence values (if exists)
            const aiConfidence = decision.ai_analysis?.raw_confidence || decision.original_confidence || decision.confidence || 0;
            const finalConfidence = decision.confidence || 0;
            
            // Use the higher of AI or final confidence, rounded to 1 decimal place
            const displayConfidence = Math.max(aiConfidence, finalConfidence);
            const roundedConfidence = Math.round(displayConfidence * 10) / 10;
            
            const aiConfidenceElement = card.querySelector('.ai-confidence-value');
            if (aiConfidenceElement) {
                aiConfidenceElement.textContent = `${roundedConfidence}%`;
            }
            
            const confidenceElement = card.querySelector('.confidence-value');
            if (confidenceElement) {
                confidenceElement.textContent = `${roundedConfidence}%`;
            }
            
            // Update timestamp with consistent formatting and proper UTC handling (if exists)
            const timeElement = card.querySelector('.time-value');
            if (timeElement) {
                const decisionTime = new Date(decision.timestamp + (decision.timestamp.includes('Z') ? '' : 'Z'));
                timeElement.textContent = formatUTCTime(decisionTime);
            }
            
            // Update AI recommendation (if exists)
            const aiRecommendation = decision.ai_analysis?.raw_decision || decision.action;
            const aiRecBadge = card.querySelector('.ai-rec-badge');
            if (aiRecBadge) {
                aiRecBadge.textContent = aiRecommendation;
                aiRecBadge.className = `badge ${
                    aiRecommendation === 'BUY' ? 'bg-success' : 
                    aiRecommendation === 'SELL' ? 'bg-danger' : 
                    'bg-secondary'
                }`;
            }
            
            // Update threshold check indicator (if exists)
            const thresholdCheck = card.querySelector('.threshold-check');
            if (thresholdCheck) {
                const checkIcon = thresholdCheck.querySelector('.fa-check-circle');
                const timesIcon = thresholdCheck.querySelector('.fa-times-circle');
                
                if (checkIcon && timesIcon) {
                    if (decision.bot_decision_logic?.confidence_threshold_check?.passed) {
                        checkIcon.style.display = 'inline';
                        timesIcon.style.display = 'none';
                    } else if (decision.bot_decision_logic?.confidence_threshold_check?.passed === false) {
                        checkIcon.style.display = 'none';
                        timesIcon.style.display = 'inline';
                    } else {
                        checkIcon.style.display = 'none';
                        timesIcon.style.display = 'none';
                    }
                }
            }
            
            // Update technical indicators if available (if exists)
            const technicalSection = card.querySelector('.technical-indicators');
            if (technicalSection && decision.ai_analysis?.technical_indicators) {
                const indicators = decision.ai_analysis.technical_indicators;
                
                // Update RSI
                const rsiValue = card.querySelector('.rsi-value');
                if (rsiValue) {
                    if (indicators.rsi?.value) {
                        rsiValue.textContent = `${indicators.rsi.value} (${indicators.rsi.signal || '--'})`;
                    } else {
                        rsiValue.textContent = '--';
                    }
                }
                
                // Update MACD
                const macdSignal = card.querySelector('.macd-signal');
                if (macdSignal) {
                    if (indicators.macd?.signal) {
                        macdSignal.textContent = indicators.macd.signal;
                    } else {
                        macdSignal.textContent = '--';
                    }
                }
                
                // Update Bollinger Bands
                const bbSignal = card.querySelector('.bb-signal');
                if (bbSignal) {
                    if (indicators.bollinger_bands?.signal) {
                        bbSignal.textContent = indicators.bollinger_bands.signal;
                    } else {
                        bbSignal.textContent = '--';
                    }
                }
                
                technicalSection.style.display = 'block';
            } else if (technicalSection) {
                technicalSection.style.display = 'none';
            }
            
            // Update risk management section (if exists)
            const riskSection = card.querySelector('.risk-management');
            if (riskSection && decision.bot_decision_logic?.risk_management_applied) {
                const riskMgmt = decision.bot_decision_logic.risk_management_applied;
                
                // Update risk level badge
                const riskBadge = card.querySelector('.risk-level-badge');
                if (riskBadge) {
                    const riskLevel = riskMgmt.position_sizing?.risk_level || 'medium';
                    riskBadge.textContent = riskLevel.toUpperCase();
                    riskBadge.className = `badge ${
                        riskLevel === 'low' ? 'bg-success' : 
                        riskLevel === 'high' ? 'bg-danger' : 
                        'bg-info'
                    }`;
                }
                
                // Update position size multiplier
                const sizeMultiplier = card.querySelector('.size-multiplier');
                if (sizeMultiplier) {
                    const multiplier = riskMgmt.position_sizing?.multiplier || 1.0;
                    sizeMultiplier.textContent = `${Math.round(multiplier * 100)}%`;
                }
                
                riskSection.style.display = 'block';
            } else if (riskSection) {
                riskSection.style.display = 'none';
            }
            
            // Update detailed analysis sections
            updateDetailedAnalysis(card, decision);
        }

        // Function to update detailed analysis sections
        function updateDetailedAnalysis(card, decision) {
            // Update AI detailed reasoning (if exists)
            const aiReasoningList = card.querySelector('.ai-reasoning-list');
            if (aiReasoningList) {
                if (decision.ai_analysis?.detailed_reasoning && Array.isArray(decision.ai_analysis.detailed_reasoning)) {
                    aiReasoningList.innerHTML = '';
                    decision.ai_analysis.detailed_reasoning.forEach(reason => {
                        const li = document.createElement('li');
                        li.textContent = reason;
                        aiReasoningList.appendChild(li);
                    });
                } else {
                    aiReasoningList.innerHTML = '<li>No detailed reasoning available</li>';
                }
            }
            
            // Update bot decision logic (if exists)
            const botLogicList = card.querySelector('.bot-logic-list');
            if (botLogicList && decision.bot_decision_logic) {
                const logic = decision.bot_decision_logic;
                
                // Threshold info
                const thresholdInfo = card.querySelector('.threshold-info');
                if (thresholdInfo) {
                    if (logic.confidence_threshold_check) {
                        const check = logic.confidence_threshold_check;
                        const roundedConfidence = Math.round(check.ai_confidence * 10) / 10;
                        thresholdInfo.textContent = `Confidence threshold: ${roundedConfidence}% vs ${check.required_threshold}% (${check.passed ? 'PASSED' : 'FAILED'})`;
                    } else {
                        thresholdInfo.textContent = 'Confidence threshold check: --';
                    }
                }
                
                // Risk info
                const riskInfo = card.querySelector('.risk-info');
                if (riskInfo) {
                    if (logic.risk_management_applied?.position_sizing) {
                        const sizing = logic.risk_management_applied.position_sizing;
                        riskInfo.textContent = `Risk management: ${sizing.reason || 'Applied'}`;
                    } else {
                        riskInfo.textContent = 'Risk management: None applied';
                    }
                }
                
                // Final reason
                const finalReason = card.querySelector('.final-reason');
                if (finalReason) {
                    finalReason.textContent = `Final decision: ${logic.final_decision_reason || 'No specific reason provided'}`;
                }
            }
            
            // Update execution context (if exists)
            const executionList = card.querySelector('.execution-context-list');
            if (executionList && decision.execution_context) {
                const context = decision.execution_context;
                
                // Data quality
                const dataQuality = card.querySelector('.data-quality');
                if (dataQuality) {
                    dataQuality.textContent = `Market data quality: ${context.market_data_quality || '--'}`;
                }
                
                // Analysis duration
                const analysisDuration = card.querySelector('.analysis-duration');
                if (analysisDuration) {
                    const duration = context.analysis_duration_ms ? `${context.analysis_duration_ms}ms` : '--';
                    analysisDuration.textContent = `Analysis duration: ${duration}`;
                }
                
                // Model used
                const modelUsed = card.querySelector('.model-used');
                if (modelUsed) {
                    modelUsed.textContent = `LLM model: ${context.llm_model_used || '--'}`;
                }
            }
        }

        // Function to update trading strategy status
        function updateTradingStrategyStatus(portfolioData) {
            try {
                const strategyText = document.getElementById('trading-strategy-text');
                const strategyBadge = document.getElementById('trading-strategy-badge');
                
                if (!portfolioData) {
                    if (strategyText) {
                        strategyText.textContent = 'No portfolio data available';
                    }
                    return;
                }
                
                const totalValue = portfolioData?.portfolio_value_eur;
                let totalValueAmount;
                if (typeof totalValue === 'object' && totalValue !== null) {
                    totalValueAmount = totalValue.amount || 0;
                } else {
                    totalValueAmount = totalValue || 0;
                }
                const eurBalance = portfolioData?.EUR?.amount || 0;
                
                // Check safety limits
                const minEurBalance = 50.0;
                const maxEurAllocation = 35.0;
                
                let statusMessage = 'AI decisions prioritized with smart safety limits';
                let statusClass = 'text-success';
                let badgeClass = 'bg-success';
                
                if (totalValueAmount > 0) {
                    const eurAllocation = (eurBalance / totalValueAmount) * 100;
                    
                    if (eurBalance < minEurBalance) {
                        statusMessage = `Low EUR balance (${formatCurrency(eurBalance)} < €${minEurBalance}) - BUY orders limited`;
                        statusClass = 'text-warning';
                        badgeClass = 'bg-warning';
                    } else if (eurAllocation > maxEurAllocation) {
                        statusMessage = `High EUR allocation (${safeToFixed(eurAllocation, 1)}% > ${maxEurAllocation}%) - SELL orders limited`;
                        statusClass = 'text-info';
                        badgeClass = 'bg-info';
                    }
                }
                
                if (strategyText) {
                    strategyText.innerHTML = `<i class="fas fa-check-circle ${statusClass}"></i> ${statusMessage}`;
                }
                
                if (strategyBadge) {
                    strategyBadge.className = `badge ${badgeClass}`;
                    strategyBadge.innerHTML = '<i class="fas fa-brain me-1"></i>AI-Driven';
                }
                
            } catch (error) {
                console.error('Error updating trading strategy status:', error);
            }
        }

        // Function to update portfolio data
        async function updatePortfolio() {
            const data = await loadData('./data/portfolio/portfolio.json');
            const performanceData = await loadData('./data/dashboard/performance_data.json');
            
            if (data) {
                // Handle both dict and float formats for portfolio_value_eur
                let portfolioValue;
                if (typeof data.portfolio_value_eur === 'object' && data.portfolio_value_eur !== null) {
                    portfolioValue = data.portfolio_value_eur.amount || 0;
                } else {
                    portfolioValue = data.portfolio_value_eur || 0;
                }
                
                document.getElementById('total-value').textContent = formatCurrency(portfolioValue);
                
                // Update time-based percentage changes using performance data and portfolio history
                await updatePortfolioChanges(portfolioValue, performanceData);

                // Update trading strategy status
                updateTradingStrategyStatus(data);

                // Calculate current allocations
                const totalValue = portfolioValue;
                const current = {
                    BTC: (data.BTC?.amount * data.BTC?.last_price_eur / totalValue) * 100 || 0,
                    ETH: (data.ETH?.amount * data.ETH?.last_price_eur / totalValue) * 100 || 0,
                    SOL: (data.SOL?.amount * data.SOL?.last_price_eur / totalValue) * 100 || 0,
                    EUR: (data.EUR?.amount / totalValue) * 100 || 0
                };

                // Update allocation chart (current holdings only)
                updateAllocationComparison(current, data);
            }
        }

        // Function to update portfolio percentage changes for different time periods
        async function updatePortfolioChanges(currentValue, performanceData) {
            try {
                const changes = {
                    '1h': { value: 0, percent: 0 },
                    '4h': { value: 0, percent: 0 },
                    '24h': { value: 0, percent: 0 },
                    '5d': { value: 0, percent: 0 }
                };

                // Use performance data if available and recent
                if (performanceData && performanceData.period_data) {
                    const trackingInfo = performanceData.tracking_info;
                    const isRecentTracking = trackingInfo && trackingInfo.tracking_start_date;
                    
                    if (isRecentTracking) {
                        const startDate = new Date(trackingInfo.tracking_start_date);
                        const now = new Date();
                        const trackingHours = (now - startDate) / (1000 * 60 * 60);
                        
                        // Only use performance data if tracking is recent enough
                        if (trackingHours >= 1 && performanceData.period_data['7d']) {
                            const weekData = performanceData.period_data['7d'];
                            const totalPercent = weekData.total_return_percent || 0;
                            const totalValue = weekData.absolute_change || 0;
                            
                            // Estimate shorter periods based on available data
                            if (trackingHours >= 24) {
                                changes['24h'].percent = totalPercent;
                                changes['24h'].value = totalValue;
                                changes['5d'].percent = totalPercent;
                                changes['5d'].value = totalValue;
                            }
                            
                            if (trackingHours >= 4) {
                                changes['4h'].percent = totalPercent * (4 / trackingHours);
                                changes['4h'].value = totalValue * (4 / trackingHours);
                            }
                            
                            if (trackingHours >= 1) {
                                changes['1h'].percent = totalPercent * (1 / trackingHours);
                                changes['1h'].value = totalValue * (1 / trackingHours);
                            }
                        }
                    }
                }

                // Fallback: Try to load portfolio history for more accurate calculations
                const portfolioHistory = await loadPortfolioHistory();
                if (portfolioHistory && portfolioHistory.length > 0) {
                    const now = new Date();
                    const timeframes = {
                        '1h': 1 * 60 * 60 * 1000,
                        '4h': 4 * 60 * 60 * 1000,
                        '24h': 24 * 60 * 60 * 1000,
                        '5d': 5 * 24 * 60 * 60 * 1000
                    };

                    for (const [period, milliseconds] of Object.entries(timeframes)) {
                        const targetTime = new Date(now.getTime() - milliseconds);
                        
                        // Find the closest historical value
                        let closestEntry = null;
                        let closestTimeDiff = Infinity;
                        
                        for (const entry of portfolioHistory) {
                            if (!entry.portfolio_value_eur || entry.portfolio_value_eur === 'None') continue;
                            
                            try {
                                const entryTime = new Date(entry.timestamp);
                                const timeDiff = Math.abs(entryTime.getTime() - targetTime.getTime());
                                
                                if (timeDiff < closestTimeDiff) {
                                    closestTimeDiff = timeDiff;
                                    closestEntry = entry;
                                }
                            } catch (e) {
                                continue;
                            }
                        }
                        
                        if (closestEntry && closestTimeDiff < milliseconds * 0.5) {
                            const historicalValue = parseFloat(closestEntry.portfolio_value_eur);
                            if (historicalValue > 0) {
                                changes[period].value = currentValue - historicalValue;
                                changes[period].percent = ((currentValue - historicalValue) / historicalValue) * 100;
                            }
                        }
                    }
                }

                // Update the UI
                updateChangeDisplay('change-1h', changes['1h']);
                updateChangeDisplay('change-4h', changes['4h']);
                updateChangeDisplay('change-24h', changes['24h']);
                updateChangeDisplay('change-5d', changes['5d']);

            } catch (error) {
                console.error('Error updating portfolio changes:', error);
                // Set all to neutral if error
                ['change-1h', 'change-4h', 'change-24h', 'change-5d'].forEach(id => {
                    updateChangeDisplay(id, { percent: 0, value: 0 });
                });
            }
        }

        // Helper function to update individual change display
        function updateChangeDisplay(elementId, change) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const percent = change.percent || 0;
            const absPercent = Math.abs(percent);
            
            let className = 'text-muted';
            let icon = 'fa-minus';
            
            if (percent > 0.01) {
                className = 'text-success';
                icon = 'fa-caret-up';
            } else if (percent < -0.01) {
                className = 'text-danger';
                icon = 'fa-caret-down';
            }
            
            element.className = className;
            element.innerHTML = `<i class="fas ${icon}"></i> ${safeToFixed(absPercent)}%`;
        }

        // Function to load portfolio history
        async function loadPortfolioHistory() {
            try {
                const response = await fetch('./data/portfolio/portfolio_history.csv');
                if (!response.ok) return null;
                
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                
                if (lines.length <= 1) return null;
                
                const headers = lines[0].split(',');
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const entry = {};
                    
                    headers.forEach((header, index) => {
                        entry[header.trim()] = values[index]?.trim();
                    });
                    
                    data.push(entry);
                }
                
                return data;
            } catch (error) {
                console.error('Error loading portfolio history:', error);
                return null;
            }
        }

        // Function to update intelligent rebalancing status based on portfolio data
        function updateRebalanceStatusFromData(portfolioData) {
            try {
                const rebalanceStatusText = document.getElementById('rebalance-status-text');
                const rebalanceDetails = document.getElementById('rebalance-details');
                const timingInfo = document.getElementById('rebalance-timing-info');
                const marketInfo = document.getElementById('rebalance-market-info');
                const totalValueRaw = portfolioData?.portfolio_value_eur;
                let totalValue;
                if (typeof totalValueRaw === 'object' && totalValueRaw !== null) {
                    totalValue = totalValueRaw.amount || 0;
                } else {
                    totalValue = totalValueRaw || 0;
                }
                
                if (totalValue <= 0) {
                    rebalanceStatusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> No portfolio data available';
                    rebalanceStatusText.className = 'text-warning';
                    rebalanceDetails.style.display = 'none';
                    return;
                }
                
                // Calculate current allocation
                const current = {
                    BTC: (portfolioData.BTC?.amount * portfolioData.BTC?.last_price_eur / totalValue) * 100 || 0,
                    ETH: (portfolioData.ETH?.amount * portfolioData.ETH?.last_price_eur / totalValue) * 100 || 0,
                    SOL: (portfolioData.SOL?.amount * portfolioData.SOL?.last_price_eur / totalValue) * 100 || 0,
                    EUR: (portfolioData.EUR?.amount / totalValue) * 100 || 0
                };
                
                // Target allocation
                const target = {BTC: 26.7, ETH: 26.7, SOL: 26.7, EUR: 20.0};
                const threshold = 5.0; // 5% threshold
                
                // Analyze rebalancing need
                let maxDeviation = 0;
                let needsRebalancing = false;
                let criticalAssets = [];
                let urgentAssets = [];
                
                for (const asset of ['BTC', 'ETH', 'SOL', 'EUR']) {
                    const deviation = Math.abs(current[asset] - target[asset]);
                    maxDeviation = Math.max(maxDeviation, deviation);
                    
                    if (deviation > threshold * 3) { // 15% = critical
                        criticalAssets.push(asset);
                        needsRebalancing = true;
                    } else if (deviation > threshold * 2) { // 10% = urgent
                        urgentAssets.push(asset);
                        needsRebalancing = true;
                    } else if (deviation > threshold) { // 5% = needed
                        needsRebalancing = true;
                    }
                }
                
                // Determine severity and status
                let severity, statusClass, statusIcon, statusMessage, timingMessage, marketMessage;
                
                if (criticalAssets.length > 0) {
                    severity = 'critical';
                    statusClass = 'text-danger';
                    statusIcon = 'fas fa-exclamation-triangle';
                    statusMessage = `Critical rebalancing needed (${safeToFixed(maxDeviation, 1)}% deviation)`;
                    timingMessage = `<i class="fas fa-clock"></i> Will execute immediately regardless of market conditions`;
                    marketMessage = `<i class="fas fa-chart-line"></i> Critical assets: ${criticalAssets.join(', ')}`;
                } else if (urgentAssets.length > 0) {
                    severity = 'urgent';
                    statusClass = 'text-warning';
                    statusIcon = 'fas fa-exclamation-circle';
                    statusMessage = `Urgent rebalancing needed (${safeToFixed(maxDeviation, 1)}% deviation)`;
                    timingMessage = `<i class="fas fa-clock"></i> Will execute when market conditions are favorable`;
                    marketMessage = `<i class="fas fa-chart-line"></i> Urgent assets: ${urgentAssets.join(', ')}`;
                } else if (needsRebalancing) {
                    severity = 'moderate';
                    statusClass = 'text-info';
                    statusIcon = 'fas fa-info-circle';
                    statusMessage = `Rebalancing needed (${safeToFixed(maxDeviation, 1)}% deviation)`;
                    timingMessage = `<i class="fas fa-clock"></i> Waiting for optimal market conditions`;
                    marketMessage = `<i class="fas fa-chart-line"></i> Monitoring volatility and trends`;
                } else {
                    severity = 'balanced';
                    statusClass = 'text-success';
                    statusIcon = 'fas fa-check-circle';
                    statusMessage = `Portfolio balanced (${safeToFixed(maxDeviation, 1)}% max deviation)`;
                    timingMessage = `<i class="fas fa-clock"></i> Next check in ~3 hours`;
                    marketMessage = `<i class="fas fa-chart-line"></i> All assets within target ranges`;
                }
                
                // Update status display
                rebalanceStatusText.innerHTML = `<i class="${statusIcon}"></i> ${statusMessage}`;
                rebalanceStatusText.className = statusClass;
                
                // Update detailed information
                if (needsRebalancing) {
                    timingInfo.innerHTML = timingMessage;
                    marketInfo.innerHTML = marketMessage;
                    rebalanceDetails.style.display = 'block';
                } else {
                    rebalanceDetails.style.display = 'none';
                }
                
                // Update mode badge based on severity
                const modeBadge = document.getElementById('rebalance-mode-badge');
                if (severity === 'critical') {
                    modeBadge.className = 'badge bg-danger';
                    modeBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Critical';
                } else if (severity === 'urgent') {
                    modeBadge.className = 'badge bg-warning';
                    modeBadge.innerHTML = '<i class="fas fa-clock me-1"></i>Urgent';
                } else if (severity === 'moderate') {
                    modeBadge.className = 'badge bg-info';
                    modeBadge.innerHTML = '<i class="fas fa-brain me-1"></i>Analyzing';
                } else {
                    modeBadge.className = 'badge bg-success';
                    modeBadge.innerHTML = '<i class="fas fa-check me-1"></i>Balanced';
                }
                
            } catch (error) {
                console.error('Error updating intelligent rebalance status:', error);
                const rebalanceStatusText = document.getElementById('rebalance-status-text');
                rebalanceStatusText.innerHTML = '<i class="fas fa-times-circle"></i> Error analyzing rebalancing status';
                rebalanceStatusText.className = 'text-danger';
            }
        }

        // Function to format AI reasoning from trade data
        function formatAIReasoning(trade) {
            try {
                // Try to get detailed reasoning from the trade data
                let reasoning = [];
                
                // Check if we have detailed AI analysis data
                if (trade.ai_analysis && trade.ai_analysis.detailed_reasoning) {
                    reasoning = trade.ai_analysis.detailed_reasoning;
                } else if (trade.detailed_reasoning) {
                    reasoning = trade.detailed_reasoning;
                } else if (trade.reason && trade.reason !== 'No detailed reasoning provided') {
                    reasoning = [trade.reason];
                } else {
                    reasoning = ['AI analysis completed with standard market evaluation'];
                }
                
                // Format as bullet points
                return reasoning.map(point => `<div class="reasoning-point"><i class="fas fa-arrow-right me-2 text-primary"></i>${point}</div>`).join('');
                
            } catch (error) {
                console.error('Error formatting AI reasoning:', error);
                return '<div class="reasoning-point"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>AI reasoning data not available</div>';
            }
        }
        
        // Function to format technical indicators
        function formatTechnicalIndicators(trade) {
            try {
                if (!trade.ai_analysis || !trade.ai_analysis.technical_indicators) {
                    return '<div class="indicator-item"><span class="text-muted">Technical indicator data not available for this trade. <br><small>This may be a HOLD decision or older trade without detailed analysis.</small></span></div>';
                }
                
                const indicators = trade.ai_analysis.technical_indicators;
                let html = '<div class="row">';
                
                // RSI
                if (indicators.rsi) {
                    const rsiValue = indicators.rsi.value || 0;
                    const rsiColor = rsiValue > 70 ? 'text-danger' : rsiValue < 30 ? 'text-success' : 'text-warning';
                    html += `
                        <div class="col-md-4">
                            <div class="indicator-card">
                                <div class="indicator-header">
                                    <span class="indicator-name">RSI</span>
                                    <span class="indicator-value ${rsiColor}">${rsiValue}</span>
                                </div>
                                <div class="indicator-signal">
                                    <span class="badge ${getSignalBadgeClass(indicators.rsi.signal)}">${indicators.rsi.signal}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // MACD
                if (indicators.macd) {
                    const macdSignal = indicators.macd.signal || 'neutral';
                    html += `
                        <div class="col-md-4">
                            <div class="indicator-card">
                                <div class="indicator-header">
                                    <span class="indicator-name">MACD</span>
                                    <span class="indicator-value">${safeToFixed(indicators.macd.macd_line, 3)}</span>
                                </div>
                                <div class="indicator-signal">
                                    <span class="badge ${getSignalBadgeClass(macdSignal)}">${macdSignal}</span>
                                </div>
                                <div class="indicator-details">
                                    <small>Signal: ${safeToFixed(indicators.macd.signal_line, 3)}</small><br>
                                    <small>Histogram: ${safeToFixed(indicators.macd.histogram, 3)}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Bollinger Bands
                if (indicators.bollinger_bands) {
                    const bbSignal = indicators.bollinger_bands.signal || 'normal';
                    html += `
                        <div class="col-md-4">
                            <div class="indicator-card">
                                <div class="indicator-header">
                                    <span class="indicator-name">Bollinger Bands</span>
                                </div>
                                <div class="indicator-signal">
                                    <span class="badge ${getSignalBadgeClass(bbSignal)}">${bbSignal}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                return html;
                
            } catch (error) {
                console.error('Error formatting technical indicators:', error);
                return '<div class="indicator-item"><span class="text-muted">Error loading technical indicators</span></div>';
            }
        }
        
        // Function to format bot decision logic
        function formatBotDecisionLogic(trade) {
            try {
                if (!trade.bot_decision_logic) {
                    return `
                        <div class="decision-item">
                            <strong>AI Recommendation:</strong> ${trade.ai_recommendation || trade.action}
                            <br><strong>Confidence:</strong> ${trade.confidence}%
                            <br><strong>Final Decision:</strong> ${trade.action}
                        </div>
                    `;
                }
                
                const logic = trade.bot_decision_logic;
                let html = '<div class="decision-logic-details">';
                
                // AI Recommendation
                html += `<div class="decision-item"><strong>AI Recommendation:</strong> <span class="badge bg-primary">${logic.ai_recommendation}</span></div>`;
                
                // Confidence Check
                if (logic.confidence_threshold_check) {
                    const check = logic.confidence_threshold_check;
                    const passedColor = check.passed ? 'text-success' : 'text-danger';
                    const passedIcon = check.passed ? 'fa-check-circle' : 'fa-times-circle';
                    html += `
                        <div class="decision-item">
                            <strong>Confidence Check:</strong> 
                            <span class="${passedColor}"><i class="fas ${passedIcon} me-1"></i>${check.ai_confidence}% vs ${check.required_threshold}% required</span>
                        </div>
                    `;
                }
                
                // Risk Management
                if (logic.risk_management_applied && logic.risk_management_applied.position_sizing) {
                    const sizing = logic.risk_management_applied.position_sizing;
                    html += `
                        <div class="decision-item">
                            <strong>Market Risk Management:</strong> ${sizing.risk_level} risk (${(sizing.multiplier * 100).toFixed(0)}% position size)
                            <small class="d-block text-muted">${sizing.reason}</small>
                        </div>
                    `;
                }
                
                // Final Decision
                html += `<div class="decision-item"><strong>Final Decision:</strong> <span class="badge bg-secondary">${trade.action}</span></div>`;
                
                html += '</div>';
                return html;
                
            } catch (error) {
                console.error('Error formatting bot decision logic:', error);
                return '<div class="decision-item"><span class="text-muted">Decision logic formatting error</span></div>';
            }
        }
        
        // Function to format market context
        function formatMarketContext(trade) {
            try {
                let html = '<div class="market-context-details">';
                
                // Basic trade information always available
                html += `
                    <div class="context-item">
                        <strong>Trade Price:</strong> ${formatCurrency(trade.price)}
                    </div>
                    <div class="context-item">
                        <strong>Product:</strong> ${trade.product_id}
                    </div>
                `;
                
                // Market Data from detailed analysis
                if (trade.market_data && trade.market_data.price_changes) {
                    html += '<div class="context-item"><strong>Price Changes:</strong><br>';
                    Object.entries(trade.market_data.price_changes).forEach(([period, change]) => {
                        const changeColor = change > 0 ? 'text-success' : change < 0 ? 'text-danger' : 'text-muted';
                        const changeIcon = change > 0 ? 'fa-arrow-up' : change < 0 ? 'fa-arrow-down' : 'fa-minus';
                        html += `<small class="${changeColor}"><i class="fas ${changeIcon} me-1"></i>${period}: ${change > 0 ? '+' : ''}${change}%</small> `;
                    });
                    html += '</div>';
                }
                
                // Market Conditions from AI analysis
                if (trade.ai_analysis && trade.ai_analysis.market_conditions) {
                    const conditions = trade.ai_analysis.market_conditions;
                    html += `
                        <div class="context-item">
                            <strong>Market Conditions:</strong>
                            <span class="badge bg-info">${conditions.trend}</span>
                            <span class="badge bg-secondary">${conditions.volatility} volatility</span>
                            <span class="badge bg-outline-secondary">${conditions.volume} volume</span>
                        </div>
                    `;
                } else {
                    // Fallback for trades without detailed analysis
                    html += `
                        <div class="context-item">
                            <strong>Market Analysis:</strong> 
                            <span class="text-muted">Detailed market conditions not available for this trade</span>
                            <br><small>This may be a HOLD decision or older trade without comprehensive analysis.</small>
                        </div>
                    `;
                }
                
                // Risk Assessment
                if (trade.ai_analysis && trade.ai_analysis.risk_assessment) {
                    const riskColor = trade.ai_analysis.risk_assessment === 'high' ? 'bg-danger' : 
                                     trade.ai_analysis.risk_assessment === 'medium' ? 'bg-warning' : 'bg-success';
                    html += `
                        <div class="context-item">
                            <strong>Risk Assessment:</strong> 
                            <span class="badge ${riskColor}">${trade.ai_analysis.risk_assessment}</span>
                        </div>
                    `;
                }
                
                // Execution Context
                if (trade.execution_context) {
                    const context = trade.execution_context;
                    html += `
                        <div class="context-item">
                            <strong>Analysis Quality:</strong> ${context.data_points_analyzed} data points, ${(context.analysis_duration_ms / 1000).toFixed(1)}s analysis
                            <br><small class="text-muted">Model: ${context.llm_model_used || 'N/A'}</small>
                        </div>
                    `;
                }
                
                html += '</div>';
                return html;
                
            } catch (error) {
                console.error('Error formatting market context:', error);
                return '<div class="context-item"><span class="text-muted">Market context not available</span></div>';
            }
        }

        // Function to update allocation chart (current holdings only)
        function updateAllocationComparison(current, portfolioData) {
            const ctx = document.getElementById('allocationComparisonChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.allocationChart) {
                window.allocationChart.destroy();
            }
            
            // Calculate EUR values for each asset
            const totalValueRaw = portfolioData?.portfolio_value_eur;
            let totalValue;
            if (typeof totalValueRaw === 'object' && totalValueRaw !== null) {
                totalValue = totalValueRaw.amount || 0;
            } else {
                totalValue = totalValueRaw || 0;
            }
            const btcValue = (portfolioData?.BTC?.amount * portfolioData?.BTC?.last_price_eur) || 0;
            const ethValue = (portfolioData?.ETH?.amount * portfolioData?.ETH?.last_price_eur) || 0;
            const solValue = (portfolioData?.SOL?.amount * portfolioData?.SOL?.last_price_eur) || 0;
            const eurCashValue = portfolioData?.EUR?.amount || 0;
            
            window.allocationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['BTC', 'ETH', 'SOL', 'EUR'],
                    datasets: [
                        {
                            label: 'Current Holdings',
                            data: [
                                current.BTC || 0,
                                current.ETH || 0,
                                current.SOL || 0,
                                current.EUR || 0
                            ],
                            backgroundColor: ['#f39c12', '#3498db', '#2ecc71', '#95a5a6'],  // More vibrant colors for light theme
                            borderColor: ['#e67e22', '#2980b9', '#27ae60', '#7f8c8d'],      // Darker borders for better contrast
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false  // Hide legend since we only have one dataset
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const asset = context.label;
                                    const percentage = context.parsed.y.toFixed(1);
                                    let value = 0;
                                    
                                    switch(asset) {
                                        case 'BTC': value = btcValue; break;
                                        case 'ETH': value = ethValue; break;
                                        case 'SOL': value = solValue; break;
                                        case 'EUR': value = eurCashValue; break;
                                    }
                                    
                                    return `${asset}: ${percentage}% (€${value.toFixed(2)})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(50, Math.max(current.BTC || 0, current.ETH || 0, current.SOL || 0, current.EUR || 0) + 5),
                            ticks: {
                                color: '#495057',  // Dark gray text
                                callback: value => value + '%'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'  // Light gray grid lines
                            },
                            title: {
                                display: true,
                                text: 'Portfolio Allocation',
                                color: '#495057'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#495057',  // Dark gray text for asset labels
                                callback: function(value, index) {
                                    const asset = this.getLabelForValue(value);
                                    const percentage = current[asset] || 0;
                                    let eurValue = 0;
                                    
                                    switch(asset) {
                                        case 'BTC': eurValue = btcValue; break;
                                        case 'ETH': eurValue = ethValue; break;
                                        case 'SOL': eurValue = solValue; break;
                                        case 'EUR': eurValue = eurCashValue; break;
                                    }
                                    
                                    return `${asset}\n${percentage.toFixed(1)}%\n€${eurValue.toFixed(0)}`;
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'  // Very light grid lines
                            }
                        }
                    }
                }
            });
        }

        // Function to load detailed AI analysis for a trade
        async function loadDetailedAnalysis(trade) {
            try {
                // Try to find the corresponding detailed analysis file
                const timestamp = new Date(trade.timestamp);
                const dateStr = timestamp.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = timestamp.toISOString().slice(11, 19).replace(/:/g, '');
                
                // Try different possible filename formats
                const possibleFiles = [
                    `/crypto-bot/data/${trade.product_id}_${dateStr}_${timeStr}.json`,
                    `/crypto-bot/data/${trade.product_id}_${timestamp.toISOString().slice(0, 16).replace(/[-:]/g, '').replace('T', '_')}.json`
                ];
                
                for (const filename of possibleFiles) {
                    try {
                        const detailedData = await loadData(filename);
                        if (detailedData && detailedData.ai_analysis) {
                            return detailedData;
                        }
                    } catch (e) {
                        // File doesn't exist, try next
                        continue;
                    }
                }
                
                // If no detailed file found, return the trade data itself
                return trade;
                
            } catch (error) {
                console.warn('Could not load detailed analysis for trade:', error);
                return trade;
            }
        }

        // Function to load detailed trade analysis
        async function loadDetailedTradeAnalysis(trade) {
            try {
                // Generate filename based on trade timestamp and product
                const tradeTime = new Date(trade.timestamp);
                const year = tradeTime.getFullYear();
                const month = String(tradeTime.getMonth() + 1).padStart(2, '0');
                const day = String(tradeTime.getDate()).padStart(2, '0');
                const hour = String(tradeTime.getHours()).padStart(2, '0');
                const minute = String(tradeTime.getMinutes()).padStart(2, '0');
                const second = String(tradeTime.getSeconds()).padStart(2, '0');
                
                // Use the product_id from the trade to ensure correct currency
                const filename = `${trade.product_id.replace('-', '_')}_${year}${month}${day}_${hour}${minute}${second}.json`;
                
                // Check if file is in our available files list
                const availableFiles = await getAvailableAnalysisFiles();
                if (!availableFiles.has(filename)) {
                    // File not available, return trade data without making HTTP request
                    return trade;
                }
                
                const detailedData = await loadDetailedAnalysisData(`/crypto-bot/data/${filename}`);
                
                if (detailedData && detailedData.ai_analysis) {
                    // Merge detailed data with trade data
                    return {
                        ...trade,
                        ai_analysis: detailedData.ai_analysis,
                        bot_decision_logic: detailedData.bot_decision_logic,
                        market_data: detailedData.market_data || {
                            price: trade.price,
                            product_id: trade.product_id
                        }
                    };
                }
                
                // If no detailed file found, return the trade data itself
                return trade;
                
            } catch (error) {
                // Only log unexpected errors, not missing files
                return trade;
            }
        }

        // Function to update trade history with filtering
        async function updateTradeHistory() {
            const data = await loadData('./data/trades/trade_history.json');
            
            if (data && Array.isArray(data)) {
                let filteredTrades = data;
                
                // Apply filters (with null checks)
                const assetFilterEl = document.getElementById('asset-filter');
                const actionFilterEl = document.getElementById('action-filter');
                const timeFilterEl = document.getElementById('time-filter');
                const sortFilterEl = document.getElementById('sort-filter');
                
                const assetFilter = assetFilterEl ? assetFilterEl.value : '';
                const actionFilter = actionFilterEl ? actionFilterEl.value : '';
                const timeFilter = timeFilterEl ? timeFilterEl.value : 'all';
                const sortFilter = sortFilterEl ? sortFilterEl.value : 'time-desc';

                if (assetFilter) {
                    filteredTrades = filteredTrades.filter(trade => trade.product_id.split('-')[0] === assetFilter);
                }

                if (actionFilter) {
                    filteredTrades = filteredTrades.filter(trade => trade.action.toUpperCase() === actionFilter);
                }

                if (timeFilter !== 'all') {
                    const now = new Date();
                    const timeLimit = {
                        '6h': 6 * 60 * 60 * 1000,
                        '24h': 24 * 60 * 60 * 1000,
                        '7d': 7 * 24 * 60 * 60 * 1000,
                        '30d': 30 * 24 * 60 * 60 * 1000
                    }[timeFilter];
                    
                    if (timeLimit) {
                        filteredTrades = filteredTrades.filter(trade => 
                            (now - new Date(trade.timestamp)) <= timeLimit
                        );
                    }
                }

                // Apply sorting
                filteredTrades.sort((a, b) => {
                    switch (sortFilter) {
                        case 'time-desc':
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        case 'time-asc':
                            return new Date(a.timestamp) - new Date(b.timestamp);
                        case 'amount-desc':
                            return (b.crypto_amount || 0) - (a.crypto_amount || 0);
                        case 'amount-asc':
                            return (a.crypto_amount || 0) - (b.crypto_amount || 0);
                        default:
                            return new Date(b.timestamp) - new Date(a.timestamp);
                    }
                });

                // Generate enhanced trade history HTML with detailed information
                const tradeHistoryHtml = await Promise.all(filteredTrades
                    .map(async (trade, index) => {
                        const tradeTime = new Date(trade.timestamp);
                        const actionClass = trade.action === 'BUY' ? 'text-success' : 
                                          trade.action === 'SELL' ? 'text-danger' : 'text-secondary';
                        const actionIcon = trade.action === 'BUY' ? 'fa-arrow-up' : 
                                         trade.action === 'SELL' ? 'fa-arrow-down' : 'fa-minus';
                        
                        // Generate unique ID for expandable content
                        const expandId = `trade-details-${index}`;
                        
                        // Calculate total trade amount and fees
                        let tradeTotal = 0;
                        let feeAmount = 0;
                        let feePercentage = 0;
                        
                        if (trade.action !== 'HOLD' && trade.crypto_amount && trade.price) {
                            tradeTotal = parseFloat(trade.crypto_amount) * parseFloat(trade.price);
                        }
                        
                        // Get fee information from enhanced trade data
                        if (trade.total_fees) {
                            feeAmount = parseFloat(trade.total_fees);
                            if (trade.fee_percentage) {
                                feePercentage = parseFloat(trade.fee_percentage);
                            } else if (tradeTotal > 0) {
                                feePercentage = (feeAmount / tradeTotal) * 100;
                            }
                        }
                        
                        // Format fee display
                        const feeDisplay = feeAmount > 0 ? 
                            `€${feeAmount.toFixed(4)}<br><small class="text-muted">(${feePercentage.toFixed(3)}%)</small>` : 
                            `€0.00<br><small class="text-muted">(0.000%)</small>`;
                        
                        // Load detailed analysis for this trade
                        const detailedTrade = await loadDetailedTradeAnalysis(trade);
                        
                        // Prepare detailed information
                        const detailsHtml = generateTradeDetails(detailedTrade, tradeTime);
                        
                        return `
                        <tr class="trade-row">
                            <td>${formatUTCTime(tradeTime)}</td>
                            <td class="${actionClass}">
                                <i class="fas ${actionIcon}"></i> ${trade.action.toUpperCase()}
                            </td>
                            <td>${trade.product_id.split('-')[0]}</td>
                            <td>${parseFloat(trade.crypto_amount || 0).toFixed(8)}</td>
                            <td>${formatCurrency(trade.price)}</td>
                            <td>€${tradeTotal.toFixed(2)}</td>
                            <td>${feeDisplay}</td>
                            <td>${(trade.confidence || 0)}%</td>
                            <td>
                                <div class="reasoning-container">
                                    <div class="decision-reason">
                                        ${trade.reason || 'No reasoning provided'}
                                    </div>
                                    <button class="btn btn-sm btn-outline-info expand-button mt-2" 
                                            onclick="toggleTradeDetails('${expandId}')" 
                                            data-expanded="false">
                                        <i class="fas fa-chevron-down me-1"></i>Show Details
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr class="trade-details-row" id="${expandId}" style="display: none;">
                            <td colspan="9">
                                <div class="trade-details-content">
                                    ${detailsHtml}
                                </div>
                            </td>
                        </tr>
                    `}))
                    .then(results => results.join(''));
                
                const tradeHistoryElement = document.getElementById('trade-history-data');
                
                if (tradeHistoryElement) {
                    tradeHistoryElement.innerHTML = await tradeHistoryHtml;
                } else {
                    console.error('Trade history element not found');
                }
            } else {
                console.error('Trade history data not loaded or invalid format');
                const tradeHistoryElement = document.getElementById('trade-history-data');
                if (tradeHistoryElement) {
                    tradeHistoryElement.innerHTML = '<tr><td colspan="9">No trade history available</td></tr>';
                }
            }
        }

        // Function to generate detailed trade information
        function generateTradeDetails(trade, tradeTime) {
            let detailsHtml = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="detail-section">
                            <h6 class="detail-title"><i class="fas fa-info-circle me-2"></i>Trade Information</h6>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Timestamp:</span>
                                    <span class="detail-value">${tradeTime.toISOString()}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Product ID:</span>
                                    <span class="detail-value">${trade.product_id || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Action:</span>
                                    <span class="detail-value">${trade.action || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Status:</span>
                                    <span class="detail-value badge ${getStatusBadgeClass(trade.status)}">${trade.status || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">AI Recommendation:</span>
                                    <span class="detail-value">${trade.ai_recommendation || trade.intended_action || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Confidence:</span>
                                    <span class="detail-value">${trade.confidence || 0}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-section">
                            <h6 class="detail-title"><i class="fas fa-dollar-sign me-2"></i>Financial Details</h6>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Price:</span>
                                    <span class="detail-value">€${(trade.price || 0).toFixed(2)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Crypto Amount:</span>
                                    <span class="detail-value">${(trade.crypto_amount || 0).toFixed(6)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Gross EUR Amount:</span>
                                    <span class="detail-value">€${(trade.action !== 'HOLD' && trade.crypto_amount && trade.price ? (parseFloat(trade.crypto_amount) * parseFloat(trade.price)).toFixed(2) : '0.00')}</span>
                                </div>
                                ${trade.total_fees ? `
                                <div class="detail-item">
                                    <span class="detail-label">Trading Fees:</span>
                                    <span class="detail-value text-warning">€${parseFloat(trade.total_fees).toFixed(4)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Fee Percentage:</span>
                                    <span class="detail-value text-warning">${(trade.fee_percentage || 0).toFixed(3)}%</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Net EUR Amount:</span>
                                    <span class="detail-value text-success">€${(trade.actual_eur_spent || trade.total_value_after_fees || 0).toFixed(2)}</span>
                                </div>
                                ${trade.average_filled_price && parseFloat(trade.average_filled_price) !== parseFloat(trade.price || 0) ? `
                                <div class="detail-item">
                                    <span class="detail-label">Actual Fill Price:</span>
                                    <span class="detail-value">€${parseFloat(trade.average_filled_price).toFixed(2)}</span>
                                </div>
                                ` : ''}
                                ${trade.filled_size && parseFloat(trade.filled_size) !== parseFloat(trade.crypto_amount || 0) ? `
                                <div class="detail-item">
                                    <span class="detail-label">Actual Fill Size:</span>
                                    <span class="detail-value">${parseFloat(trade.filled_size).toFixed(6)}</span>
                                </div>
                                ` : ''}
                                ` : ''}
                                ${trade.skip_reason ? `
                                <div class="detail-item">
                                    <span class="detail-label">Skip Reason:</span>
                                    <span class="detail-value text-warning">${trade.skip_reason}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="detail-section">
                            <h6 class="detail-title"><i class="fas fa-brain me-2"></i>AI Analysis & Reasoning <span class="tooltip"><i class="fas fa-question-circle help-icon" style="font-size: 0.8rem;"></i><span class="tooltiptext"><h6>Comprehensive AI Analysis</h6>Detailed breakdown of the AI's decision-making process:<ul><li><strong>Market Analysis:</strong> Current market conditions and trends</li><li><strong>Technical Indicators:</strong> RSI, MACD, Bollinger Bands analysis</li><li><strong>Risk Assessment:</strong> Portfolio and market risk evaluation</li><li><strong>Reasoning:</strong> Step-by-step decision logic</li></ul><div class="example">Click "Show Details" to expand full analysis</div></span></span></h6>
                            <div class="reasoning-detailed">
                                <div class="ai-analysis-comprehensive">
                                    <div class="analysis-header">
                                        <h6><i class="fas fa-brain me-2"></i>AI Market Analysis</h6>
                                    </div>
                                    
                                    <!-- AI Reasoning -->
                                    <div class="analysis-section mb-3">
                                        <h6 class="analysis-title"><i class="fas fa-lightbulb me-2"></i>AI Reasoning</h6>
                                        <div class="reasoning-points" id="ai-reasoning-${trade.timestamp}">
                                            ${formatAIReasoning(trade)}
                                        </div>
                                    </div>
                                    
                                    <!-- Technical Indicators -->
                                    <div class="analysis-section mb-3">
                                        <h6 class="analysis-title"><i class="fas fa-chart-line me-2"></i>Technical Analysis</h6>
                                        <div class="technical-indicators" id="technical-indicators-${trade.timestamp}">
                                            ${formatTechnicalIndicators(trade)}
                                        </div>
                                    </div>
                                    
                                    <!-- Bot Decision Logic -->
                                    <div class="analysis-section mb-3">
                                        <h6 class="analysis-title"><i class="fas fa-cogs me-2"></i>Bot Decision Process</h6>
                                        <div class="decision-logic" id="decision-logic-${trade.timestamp}">
                                            ${formatBotDecisionLogic(trade)}
                                        </div>
                                    </div>
                                    
                                    <!-- Market Context -->
                                    <div class="analysis-section">
                                        <h6 class="analysis-title"><i class="fas fa-globe me-2"></i>Market Context</h6>
                                        <div class="market-context" id="market-context-${trade.timestamp}">
                                            ${formatMarketContext(trade)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ${trade.execution_message ? `
                            <div class="execution-message mt-2">
                                <strong>Execution:</strong> ${trade.execution_message}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            return detailsHtml;
        }

        // Function to get signal badge class
        function getSignalBadgeClass(signal) {
            switch(signal?.toLowerCase()) {
                case 'bullish': return 'bg-success';
                case 'bearish': return 'bg-danger';
                case 'neutral': return 'bg-secondary';
                case 'normal': return 'bg-info';
                case 'overbought': return 'bg-warning';
                case 'oversold': return 'bg-primary';
                default: return 'bg-secondary';
            }
        }

        // Function to get status badge class
        function getStatusBadgeClass(status) {
            switch(status?.toLowerCase()) {
                case 'executed': return 'bg-success';
                case 'hold': return 'bg-secondary';
                case 'skipped': return 'bg-warning';
                case 'failed': return 'bg-danger';
                default: return 'bg-info';
            }
        }

        // Function to toggle trade details
        function toggleTradeDetails(expandId) {
            const detailsRow = document.getElementById(expandId);
            const button = document.querySelector(`[onclick="toggleTradeDetails('${expandId}')"]`);
            
            if (detailsRow && button) {
                const isExpanded = button.getAttribute('data-expanded') === 'true';
                
                if (isExpanded) {
                    // Collapse
                    detailsRow.style.display = 'none';
                    button.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Show Details';
                    button.setAttribute('data-expanded', 'false');
                } else {
                    // Expand
                    detailsRow.style.display = 'table-row';
                    button.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Hide Details';
                    button.setAttribute('data-expanded', 'true');
                }
            }
        }

        // Add filter change handlers with error checking
        function setupTradeHistoryFilters() {
            ['asset-filter', 'action-filter', 'time-filter', 'sort-filter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateTradeHistory);
                } else {
                    console.warn(`Filter element ${id} not found`);
                }
            });
        }

        // Update all data initially and every 60 seconds
        function updateAllData() {
            // Header should be loaded by now, so always call updateBotStatus
            updateBotStatus();
            updateMarketData(); // This now includes recent decisions
            updatePortfolio();
            updateTradeHistory();
            
            // Refresh tooltips after data updates
            refreshTooltips();
        }

        // Global event delegation for expand buttons
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('expand-button')) {
                // Skip if this is a trade details button (handled by onclick)
                if (e.target.hasAttribute('onclick')) {
                    return;
                }
                
                // Handle market overview expand buttons (enhanced decision analysis)
                const reasoningSection = e.target.closest('.reasoning-section');
                if (reasoningSection) {
                    const detailedAnalysis = reasoningSection.querySelector('.detailed-analysis');
                    if (detailedAnalysis) {
                        // Toggle detailed analysis visibility
                        detailedAnalysis.classList.toggle('expanded');
                        e.target.textContent = detailedAnalysis.classList.contains('expanded') ? 
                            'Hide detailed analysis' : 'Show detailed analysis';
                    }
                }
            }
        });

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            loadSharedHeader().then(() => {
                setupTradeHistoryFilters();
                updateAllData();
                
                // Initialize multi-strategy functionality
                if (window.MultiStrategy) {
                    window.MultiStrategy.initialize();
                }
                
                setInterval(updateAllData, 60000);
            });
        });

        // Fallback initialization if DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // DOM is still loading, event listener will handle it
        } else {
            // DOM is already loaded
            loadSharedHeader().then(() => {
                setupTradeHistoryFilters();
                updateAllData();
                setInterval(updateAllData, 60000);
            });
        }
        
        // Initialize Bootstrap tooltips with enhanced configuration
        function initializeTooltips() {
            try {
                // Dispose of existing tooltips first
                var existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                existingTooltips.forEach(function(element) {
                    var tooltip = bootstrap.Tooltip.getInstance(element);
                    if (tooltip) {
                        tooltip.dispose();
                    }
                });

                // Initialize new tooltips
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl, {
                        html: true,
                        trigger: 'hover focus',
                        delay: { show: 300, hide: 100 },
                        container: 'body'
                    });
                });
            } catch (error) {
                console.error('Error initializing tooltips:', error);
            }
        }

        // Initialize tooltips on page load
        initializeTooltips();

        // Re-initialize tooltips when content is dynamically updated
        function refreshTooltips() {
            setTimeout(initializeTooltips, 100);
        }

        // Add some visual feedback for help icons
        document.addEventListener('DOMContentLoaded', function() {
            // Add pulse animation to help icons on first load
            setTimeout(function() {
                const helpIcons = document.querySelectorAll('.help-icon');
                helpIcons.forEach(function(icon, index) {
                    setTimeout(function() {
                        icon.style.animation = 'pulse 0.6s ease-in-out';
                        setTimeout(function() {
                            icon.style.animation = '';
                        }, 600);
                    }, index * 100);
                });
            }, 1000);
        });

        // Add CSS animation for pulse effect
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
