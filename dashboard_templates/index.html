<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crypto Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
            background-color: #f1f8ff;
        }
        .price-up {
            color: #28a745;
        }
        .price-down {
            color: #dc3545;
        }
        .risk-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .risk-low {
            background-color: #28a745;
        }
        .risk-medium {
            background-color: #ffc107;
        }
        .risk-high {
            background-color: #dc3545;
        }
        .risk-hybrid {
            background: linear-gradient(135deg, #ffc107 0%, #ffc107 50%, #dc3545 50%, #dc3545 100%);
        }
        .risk-weight-bar {
            height: 20px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
        }
        .risk-weight-low {
            background-color: #28a745;
        }
        .risk-weight-medium {
            background-color: #ffc107;
        }
        .risk-weight-high {
            background-color: #dc3545;
        }
        .refresh-btn {
            cursor: pointer;
        }
        .last-updated {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2>AI Crypto Trading Bot Dashboard</h2>
                        <div>
                            <span class="last-updated me-2">Last updated: <span id="lastUpdated">Loading...</span></span>
                            <i class="bi bi-arrow-clockwise refresh-btn" onclick="refreshData()"></i>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4>Portfolio Value: <span id="portfolioValue">Loading...</span></h4>
                                <p>Initial Value: <span id="initialValue">Loading...</span></p>
                                <p>Total Return: <span id="totalReturn">Loading...</span></p>
                            </div>
                            <div class="col-md-6">
                                <h4>Risk Profile</h4>
                                <p>
                                    Current Risk Level: 
                                    <span id="riskLevelIndicator" class="risk-indicator"></span>
                                    <span id="riskLevel">Loading...</span>
                                </p>
                                <div id="riskWeightsContainer" style="display: none;">
                                    <p>Risk Weights:</p>
                                    <div class="risk-weight-bar">
                                        <div id="lowRiskWeight" class="risk-weight-low" style="width: 0%"></div>
                                        <div id="mediumRiskWeight" class="risk-weight-medium" style="width: 0%"></div>
                                        <div id="highRiskWeight" class="risk-weight-high" style="width: 0%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small>Low: <span id="lowRiskPercentage">0%</span></small>
                                        <small>Medium: <span id="mediumRiskPercentage">0%</span></small>
                                        <small>High: <span id="highRiskPercentage">0%</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Latest Decisions</div>
                    <div class="card-body">
                        <div id="latestDecisions">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Portfolio Allocation</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <img src="images/portfolio_allocation.png" alt="Portfolio Allocation" class="img-fluid">
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Current</th>
                                            <th>Target</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allocationTable">
                                        <tr>
                                            <td colspan="4">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">Portfolio Value Over Time</div>
                    <div class="card-body">
                        <img src="images/portfolio_value.png" alt="Portfolio Value Over Time" class="img-fluid">
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">Target vs Current Allocation</div>
                    <div class="card-body">
                        <img src="images/allocation_comparison.png" alt="Target vs Current Allocation" class="img-fluid">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to load and display data
        function loadData() {
            // Load last updated timestamp
            fetch('data/last_updated.txt')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('lastUpdated').textContent = data;
                })
                .catch(error => {
                    console.error('Error loading last updated timestamp:', error);
                    document.getElementById('lastUpdated').textContent = 'Error loading data';
                });

            // Load portfolio data
            fetch('data/portfolio_data.json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('portfolioValue').textContent = `$${parseFloat(data.portfolio_value_usd).toFixed(2)}`;
                    document.getElementById('initialValue').textContent = `$${parseFloat(data.initial_value_usd).toFixed(2)}`;
                    
                    const totalReturn = parseFloat(data.total_return);
                    const totalReturnElement = document.getElementById('totalReturn');
                    totalReturnElement.textContent = `${totalReturn.toFixed(2)}%`;
                    totalReturnElement.className = totalReturn >= 0 ? 'price-up' : 'price-down';
                    
                    // Update allocation table
                    const allocationTable = document.getElementById('allocationTable');
                    allocationTable.innerHTML = '';
                    
                    for (const asset of ['BTC', 'ETH', 'USD']) {
                        if (data[asset]) {
                            const row = document.createElement('tr');
                            
                            const assetCell = document.createElement('td');
                            assetCell.textContent = asset;
                            row.appendChild(assetCell);
                            
                            const currentCell = document.createElement('td');
                            currentCell.textContent = `${parseFloat(data[asset].allocation).toFixed(1)}%`;
                            row.appendChild(currentCell);
                            
                            const targetCell = document.createElement('td');
                            targetCell.textContent = `${parseFloat(data[asset].target_allocation || 0).toFixed(1)}%`;
                            row.appendChild(targetCell);
                            
                            const statusCell = document.createElement('td');
                            const status = data[asset].rebalance_status || 'Unknown';
                            statusCell.textContent = status;
                            
                            if (status === 'Overweight') {
                                statusCell.className = 'price-down';
                            } else if (status === 'Underweight') {
                                statusCell.className = 'price-up';
                            }
                            
                            row.appendChild(statusCell);
                            allocationTable.appendChild(row);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading portfolio data:', error);
                    document.getElementById('portfolioValue').textContent = 'Error loading data';
                });

            // Load latest decisions
            fetch('data/latest_decisions.json')
                .then(response => response.json())
                .then(data => {
                    const decisionsContainer = document.getElementById('latestDecisions');
                    decisionsContainer.innerHTML = '';
                    
                    if (data.length === 0) {
                        decisionsContainer.textContent = 'No decisions available';
                        return;
                    }
                    
                    for (const decision of data) {
                        const decisionCard = document.createElement('div');
                        decisionCard.className = 'card mb-3';
                        
                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                        
                        const productId = document.createElement('span');
                        productId.textContent = decision.product_id;
                        cardHeader.appendChild(productId);
                        
                        const action = document.createElement('span');
                        action.textContent = decision.action ? decision.action.toUpperCase() : 'UNKNOWN';
                        action.className = decision.action === 'buy' ? 'badge bg-success' : 
                                          decision.action === 'sell' ? 'badge bg-danger' : 'badge bg-secondary';
                        cardHeader.appendChild(action);
                        
                        decisionCard.appendChild(cardHeader);
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';
                        
                        const priceRow = document.createElement('div');
                        priceRow.className = 'd-flex justify-content-between';
                        
                        const priceLabel = document.createElement('span');
                        priceLabel.textContent = 'Current Price:';
                        priceRow.appendChild(priceLabel);
                        
                        const priceValue = document.createElement('span');
                        priceValue.textContent = decision.current_price ? `$${parseFloat(decision.current_price).toFixed(2)}` : 'N/A';
                        priceRow.appendChild(priceValue);
                        
                        cardBody.appendChild(priceRow);
                        
                        const confidenceRow = document.createElement('div');
                        confidenceRow.className = 'd-flex justify-content-between';
                        
                        const confidenceLabel = document.createElement('span');
                        confidenceLabel.textContent = 'Confidence:';
                        confidenceRow.appendChild(confidenceLabel);
                        
                        const confidenceValue = document.createElement('span');
                        confidenceValue.textContent = decision.confidence ? `${decision.confidence}%` : 'N/A';
                        confidenceRow.appendChild(confidenceValue);
                        
                        cardBody.appendChild(confidenceRow);
                        
                        // Add risk level if available
                        if (decision.risk_level) {
                            const riskRow = document.createElement('div');
                            riskRow.className = 'd-flex justify-content-between';
                            
                            const riskLabel = document.createElement('span');
                            riskLabel.textContent = 'Risk Level:';
                            riskRow.appendChild(riskLabel);
                            
                            const riskValue = document.createElement('span');
                            const riskIndicator = document.createElement('span');
                            riskIndicator.className = `risk-indicator risk-${decision.risk_level.toLowerCase()}`;
                            riskValue.appendChild(riskIndicator);
                            riskValue.appendChild(document.createTextNode(decision.risk_level));
                            riskRow.appendChild(riskValue);
                            
                            cardBody.appendChild(riskRow);
                        }
                        
                        const reasonRow = document.createElement('div');
                        reasonRow.className = 'mt-2';
                        
                        const reasonLabel = document.createElement('div');
                        reasonLabel.textContent = 'Reason:';
                        reasonLabel.className = 'fw-bold';
                        reasonRow.appendChild(reasonLabel);
                        
                        const reasonValue = document.createElement('div');
                        reasonValue.textContent = decision.reason || 'No reason provided';
                        reasonValue.className = 'small';
                        reasonRow.appendChild(reasonValue);
                        
                        cardBody.appendChild(reasonRow);
                        
                        decisionCard.appendChild(cardBody);
                        decisionsContainer.appendChild(decisionCard);
                    }
                })
                .catch(error => {
                    console.error('Error loading latest decisions:', error);
                    document.getElementById('latestDecisions').textContent = 'Error loading decisions';
                });

            // Load config data
            fetch('data/config.json')
                .then(response => response.json())
                .then(data => {
                    // Update risk level indicator
                    const riskLevel = data.risk_level || 'unknown';
                    const riskLevelElement = document.getElementById('riskLevel');
                    riskLevelElement.textContent = riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
                    
                    const riskIndicator = document.getElementById('riskLevelIndicator');
                    riskIndicator.className = `risk-indicator risk-${riskLevel.toLowerCase()}`;
                    
                    // Update risk weights if hybrid
                    if (riskLevel.toLowerCase() === 'hybrid' && data.risk_weights) {
                        document.getElementById('riskWeightsContainer').style.display = 'block';
                        
                        const lowWeight = data.risk_weights.low * 100;
                        const mediumWeight = data.risk_weights.medium * 100;
                        const highWeight = data.risk_weights.high * 100;
                        
                        document.getElementById('lowRiskWeight').style.width = `${lowWeight}%`;
                        document.getElementById('mediumRiskWeight').style.width = `${mediumWeight}%`;
                        document.getElementById('highRiskWeight').style.width = `${highWeight}%`;
                        
                        document.getElementById('lowRiskPercentage').textContent = `${lowWeight}%`;
                        document.getElementById('mediumRiskPercentage').textContent = `${mediumWeight}%`;
                        document.getElementById('highRiskPercentage').textContent = `${highWeight}%`;
                    } else {
                        document.getElementById('riskWeightsContainer').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading config data:', error);
                });
        }

        // Function to refresh data
        function refreshData() {
            // Show loading indicator
            document.getElementById('lastUpdated').textContent = 'Refreshing...';
            
            // Call API to refresh portfolio
            fetch('/api/refresh_portfolio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Portfolio refresh response:', data);
                // Reload data after a short delay
                setTimeout(loadData, 1000);
            })
            .catch(error => {
                console.error('Error refreshing portfolio:', error);
                document.getElementById('lastUpdated').textContent = 'Error refreshing data';
                // Try to reload data anyway
                setTimeout(loadData, 1000);
            });
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadData);
        
        // Refresh data every 60 seconds
        setInterval(loadData, 60000);
    </script>
</body>
</html>
